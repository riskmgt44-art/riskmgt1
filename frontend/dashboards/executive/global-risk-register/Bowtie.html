<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bowtie Diagram – RiskMGT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary: #5DA1A1;
            --primary-hover: #4e9393;
            --green: #10b981;
            --amber: #f59e0b;
            --red: #ef4444;
            --blue: #3b82f6;
            --purple: #8b5cf6;
            --neutral: #6b7280;
            --text-primary: #111111;
            --text-secondary: #555555;
            --text-muted: #888888;
            --bg: #FFFFFF;
            --card-bg: #FFFFFF;
            --border: #e8e8e8;
            --shadow-sm: 0 3.2px 9.6px rgba(0,0,0,0.06);
            --shadow-md: 0 9.6px 25.6px rgba(0,0,0,0.08);
            --shadow-lg: 0 16px 40px rgba(0,0,0,0.1);
            --radius: 12.8px;
            --transition: all 0.3s ease;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Top Navigation */
        .top-nav {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .back-btn:hover {
            background: rgba(93,161,161,0.06);
            color: var(--primary);
        }
        
        .nav-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 9.6px;
            background: transparent;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }
        
        .btn-icon:hover {
            background: rgba(93,161,161,0.06);
            color: var(--primary);
        }
        
        .btn-primary {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 9.6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
        }
        
        /* Main Content */
        main {
            padding-top: 88px;
            padding-bottom: 40px;
            padding-left: 24px;
            padding-right: 24px;
            min-height: calc(100vh - 64px);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Compact Stats */
        .compact-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .stat-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }
        
        .stat-value {
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 10px;
        }
        
        .icon-threat { background: rgba(239,68,68,0.1); color: var(--red); }
        .icon-barrier { background: rgba(16,185,129,0.1); color: var(--green); }
        .icon-consequence { background: rgba(245,158,11,0.1); color: var(--amber); }
        .icon-coverage { background: rgba(93,161,161,0.1); color: var(--primary); }
        
        /* Diagram Container */
        .diagram-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            padding: 30px;
            margin-bottom: 24px;
            position: relative;
            width: 100%;
            max-width: 1000px;
            min-height: 500px;
        }
        
        .diagram-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .diagram-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .diagram-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .diagram-legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        /* Compact Bowtie Container */
        .bowtie-container {
            width: 100%;
            height: 400px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
        }
        
        .bowtie-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }
        
        /* Compact Nodes */
        .threat-node {
            fill: #fee2e2;
            stroke: var(--red);
            stroke-width: 1.5;
            rx: 8;
            ry: 8;
            transition: all 0.3s ease;
            cursor: pointer;
            filter: drop-shadow(0 2px 4px rgba(239,68,68,0.1));
        }
        
        .threat-node:hover {
            fill: #fecaca;
            stroke-width: 2;
            transform: translateY(-1px);
            filter: drop-shadow(0 4px 8px rgba(239,68,68,0.15));
        }
        
        .consequence-node {
            fill: #ffedd5;
            stroke: var(--amber);
            stroke-width: 1.5;
            rx: 8;
            ry: 8;
            transition: all 0.3s ease;
            cursor: pointer;
            filter: drop-shadow(0 2px 4px rgba(245,158,11,0.1));
        }
        
        .consequence-node:hover {
            fill: #fed7aa;
            stroke-width: 2;
            transform: translateY(-1px);
            filter: drop-shadow(0 4px 8px rgba(245,158,11,0.15));
        }
        
        .barrier-node {
            fill: #dbeafe;
            stroke: var(--blue);
            stroke-width: 1.5;
            rx: 8;
            ry: 8;
            transition: all 0.3s ease;
            cursor: pointer;
            filter: drop-shadow(0 2px 4px rgba(59,130,246,0.1));
        }
        
        .barrier-node:hover {
            fill: #bfdbfe;
            stroke-width: 2;
            transform: translateY(-1px);
            filter: drop-shadow(0 4px 8px rgba(59,130,246,0.15));
        }
        
        .central-event {
            fill: var(--primary);
            stroke: var(--primary);
            stroke-width: 2;
            rx: 10;
            ry: 10;
            transition: all 0.3s ease;
            cursor: pointer;
            filter: drop-shadow(0 4px 8px rgba(93,161,161,0.15));
        }
        
        .central-event:hover {
            fill: var(--primary-hover);
            stroke-width: 2.5;
            filter: drop-shadow(0 6px 12px rgba(93,161,161,0.2));
        }
        
        /* Status Dots */
        .status-dot {
            stroke: white;
            stroke-width: 1.5;
            transition: all 0.3s ease;
        }
        
        .status-completed { fill: var(--green); }
        .status-in-progress { fill: var(--amber); }
        .status-open { fill: var(--blue); }
        .status-proposed { fill: var(--purple); }
        
        /* Compact Labels */
        .node-label {
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 600;
            fill: var(--text-primary);
            text-anchor: middle;
            pointer-events: none;
        }
        
        .node-subtitle {
            font-family: 'Inter', sans-serif;
            font-size: 9px;
            fill: var(--text-secondary);
            text-anchor: middle;
            pointer-events: none;
        }
        
        /* Compact Connections */
        .connection-line {
            stroke: #e2e8f0;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
            transition: all 0.3s ease;
        }
        
        .connection-line:hover {
            stroke: var(--primary);
            stroke-width: 2.5;
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            z-index: 1000;
            min-width: 200px;
            max-width: 280px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
            font-size: 13px;
        }
        
        .tooltip.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        .tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .tooltip-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .tooltip-type {
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .type-threat { background: rgba(239,68,68,0.1); color: var(--red); }
        .type-consequence { background: rgba(245,158,11,0.1); color: var(--amber); }
        .type-barrier { background: rgba(59,130,246,0.1); color: var(--blue); }
        .type-event { background: rgba(93,161,161,0.1); color: var(--primary); }
        
        .tooltip-content {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .tooltip-meta {
            display: flex;
            gap: 12px;
            font-size: 10px;
            color: var(--text-muted);
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 24px;
        }
        
        .control-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .control-btn:hover {
            background: rgba(93,161,161,0.06);
            color: var(--primary);
        }
        
        .control-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Loading State */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: var(--radius);
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }
        
        .loading-text {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 40px;
        }
        
        .empty-icon {
            font-size: 48px;
            color: var(--border);
            margin-bottom: 16px;
        }
        
        .empty-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .empty-description {
            font-size: 13px;
            color: var(--text-secondary);
            max-width: 300px;
            margin: 0 auto 16px;
            line-height: 1.5;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: var(--shadow-md);
            border-left: 3px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 2000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            font-size: 13px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.error { border-left-color: var(--red); }
        .toast.error .toast-icon { color: var(--red); }
        .toast.success { border-left-color: var(--green); }
        .toast.success .toast-icon { color: var(--green); }
        
        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .top-nav {
                padding: 0 16px;
            }
            
            main {
                padding: 80px 16px 24px;
            }
            
            .diagram-container {
                padding: 20px;
            }
            
            .bowtie-container {
                height: 350px;
            }
            
            .compact-stats {
                gap: 12px;
            }
            
            .stat-badge {
                padding: 6px 12px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .diagram-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .diagram-legend {
                justify-content: flex-start;
            }
            
            .bowtie-container {
                height: 300px;
            }
            
            .btn-text {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
       <div class="nav-left">
    <div class="nav-title" id="bowtieTitle">Bowtie Diagram</div>
</div>
        <div class="header-actions">
            <button class="btn-icon" onclick="exportDiagram()" title="Export">
                <i class="fas fa-download"></i>
            </button>
            <button class="btn-icon" onclick="refreshDiagram()" title="Refresh">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn-primary" onclick="editBowtie()">
                <i class="fas fa-edit"></i>
                <span class="btn-text">Edit</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Compact Stats -->
        <div class="compact-stats" id="compactStats">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <!-- Diagram Container -->
        <div class="diagram-container">
            <div class="diagram-header">
                <div>
                    <h2 class="diagram-title" id="riskTitle">Risk Analysis</h2>
                    <p class="diagram-subtitle" id="riskSubtitle">Bowtie visualization</p>
                </div>
                <div class="diagram-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fee2e2; border: 1px solid var(--red);"></div>
                        <span>Threats</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dbeafe; border: 1px solid var(--blue);"></div>
                        <span>Controls</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffedd5; border: 1px solid var(--amber);"></div>
                        <span>Consequences</span>
                    </div>
                </div>
            </div>

            <!-- Compact Bowtie Diagram -->
            <div class="bowtie-container" id="bowtieContainer">
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading diagram...</div>
                </div>
                
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <h3 class="empty-title">No Data</h3>
                    <p class="empty-description">
                        No risk data available. Select a risk or load sample data.
                    </p>
                    <button class="btn-primary" onclick="loadSampleData()" style="margin-top: 12px; font-size: 13px; padding: 6px 12px;">
                        <i class="fas fa-play-circle"></i>
                        Load Sample
                    </button>
                </div>

                <svg id="bowtieSVG" viewBox="0 0 900 400" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                    <defs>
                        <marker id="arrowhead" viewBox="0 0 10 10" refX="9" refY="5" 
                                markerWidth="5" markerHeight="5" orient="auto">
                            <path d="M 0 0 L 10 5 L 0 10 z" fill="#e2e8f0"/>
                        </marker>
                        <linearGradient id="eventGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#5DA1A1;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#4e9393;stop-opacity:1" />
                        </linearGradient>
                        <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feGaussianBlur in="SourceAlpha" stdDeviation="1.5"/>
                            <feOffset dx="1" dy="1" result="offsetblur"/>
                            <feComponentTransfer>
                                <feFuncA type="linear" slope="0.1"/>
                            </feComponentTransfer>
                            <feMerge>
                                <feMergeNode/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <!-- Content will be dynamically generated -->
                </svg>
            </div>

            <!-- Tooltip -->
            <div class="tooltip" id="diagramTooltip">
                <div class="tooltip-header">
                    <div class="tooltip-title" id="tooltipTitle">Title</div>
                    <div class="tooltip-type" id="tooltipType">Type</div>
                </div>
                <div class="tooltip-content" id="tooltipContent">
                    Description appears here.
                </div>
                <div class="tooltip-meta">
                    <div class="meta-item" id="tooltipMeta1">
                        <i class="fas fa-info-circle"></i>
                        <span>Info</span>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="control-btn active" onclick="changeView('overview')">
                    <i class="fas fa-eye"></i>
                    Overview
                </button>
                <button class="control-btn" onclick="changeView('threats')">
                    <i class="fas fa-exclamation-triangle"></i>
                    Threats
                </button>
                <button class="control-btn" onclick="changeView('controls')">
                    <i class="fas fa-shield-alt"></i>
                    Controls
                </button>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

<script>
// Global variables
let currentRiskId = null;
let riskData = null;
let bowtieData = null;
let assets = [];
let actions = [];
let currentView = 'overview';
let tooltipTimeout = null;

// Initialize on load
document.addEventListener('DOMContentLoaded', async () => {
    console.log('=== Compact Bowtie Diagram Initialization ===');
    
    await loadRiskData();
    
    if (currentRiskId && riskData) {
        await fetchAllData();
        renderBowtie();
    } else {
        showEmptyState();
    }
    
    setupEventListeners();
});

// ==================== DATA LOADING ====================

async function loadRiskData() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const riskIdFromUrl = urlParams.get('riskId');
        const riskIdHuman = urlParams.get('riskIdHuman');
        const riskTitle = urlParams.get('riskTitle');
        
        if (riskIdFromUrl) {
            await fetchRiskById(riskIdFromUrl);
            return;
        }
        
        const storedRisk = localStorage.getItem('viewingRisk');
        if (storedRisk) {
            try {
                riskData = JSON.parse(storedRisk);
                currentRiskId = riskData._id || riskData.id;
                updateTitle();
                return;
            } catch (e) {
                console.error('Error parsing localStorage data:', e);
            }
        }
        
        if (riskIdHuman || riskTitle) {
            riskData = {
                _id: riskIdFromUrl || 'demo-id-' + Date.now(),
                riskId: riskIdHuman || 'DEMO-001',
                title: riskTitle || 'Demo Risk',
                description: 'Sample risk data',
                causes: ['Sample cause 1', 'Sample cause 2'],
                event: 'Sample event',
                consequences: ['Sample consequence 1', 'Sample consequence 2']
            };
            currentRiskId = riskData._id;
            updateTitle();
            return;
        }
        
    } catch (error) {
        console.error('Error loading risk data:', error);
        showToast('Failed to load risk data', 'error');
    }
}

async function fetchRiskById(riskId) {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/risks/${riskId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            riskData = await response.json();
            currentRiskId = riskData._id || riskData.id;
            updateTitle();
        } else {
            loadSampleData();
        }
    } catch (error) {
        console.error('Error fetching risk:', error);
        loadSampleData();
    }
}

async function fetchAllData() {
    showLoading(true);
    
    try {
        await Promise.all([fetchAssets(), fetchActions()]);
        buildBowtieData();
        updateCompactStats();
        renderBowtie();
        showLoading(false);
        
    } catch (error) {
        console.error('Error fetching data:', error);
        showLoading(false);
        loadSampleData();
    }
}

async function fetchAssets() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/assets', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            assets = Array.isArray(data) ? data : data.data || [];
        }
    } catch (error) {
        console.error('Error fetching assets:', error);
        assets = [];
    }
}

async function fetchActions() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/actions?populate=risk', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            actions = Array.isArray(data) ? data : data.data || [];
            
            // Filter actions for this risk
            actions = actions.filter(action => {
                if (!action.risk) return false;
                const actionRiskId = action.risk._id || action.risk.id;
                return actionRiskId === currentRiskId;
            });
        }
    } catch (error) {
        console.error('Error fetching actions:', error);
        actions = [];
    }
}

function buildBowtieData() {
    if (!riskData) {
        bowtieData = getDefaultBowtieData();
        return;
    }
    
    const threats = parseCauses(riskData.causes);
    const consequences = parseConsequences(riskData.consequences);
    const { preventiveBarriers, recoveryBarriers } = groupActionsByType(actions);
    const riskScore = calculateRiskScore(threats, consequences, preventiveBarriers, recoveryBarriers);
    
    bowtieData = {
        riskId: riskData.riskId || 'Unknown',
        title: riskData.title || 'Untitled Risk',
        description: riskData.description || '',
        centralEvent: riskData.event || 'Risk Event',
        threats: threats,
        consequences: consequences,
        preventiveBarriers: preventiveBarriers,
        recoveryBarriers: recoveryBarriers,
        riskScore: riskScore
    };
}

function updateCompactStats() {
    const statsContainer = document.getElementById('compactStats');
    if (!bowtieData) return;
    
    const stats = `
        <div class="stat-badge">
            <div class="stat-icon icon-threat">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <span class="stat-value">${bowtieData.threats.length}</span>
            <span>Threats</span>
        </div>
        <div class="stat-badge">
            <div class="stat-icon icon-barrier">
                <i class="fas fa-shield-alt"></i>
            </div>
            <span class="stat-value">${bowtieData.preventiveBarriers.length + bowtieData.recoveryBarriers.length}</span>
            <span>Controls</span>
        </div>
        <div class="stat-badge">
            <div class="stat-icon icon-consequence">
                <i class="fas fa-bolt"></i>
            </div>
            <span class="stat-value">${bowtieData.consequences.length}</span>
            <span>Consequences</span>
        </div>
        <div class="stat-badge">
            <div class="stat-icon icon-coverage">
                <i class="fas fa-chart-line"></i>
            </div>
            <span class="stat-value">${bowtieData.riskScore}%</span>
            <span>Coverage</span>
        </div>
    `;
    
    statsContainer.innerHTML = stats;
}

// ==================== RENDERING ====================

function renderBowtie() {
    if (!bowtieData) {
        showEmptyState();
        return;
    }
    
    const svg = document.getElementById('bowtieSVG');
    svg.innerHTML = '';
    svg.style.display = 'block';
    
    document.getElementById('emptyState').style.display = 'none';
    
    const svgContent = createSVGContent();
    svg.innerHTML = svgContent;
    
    setupSVGInteractivity();
    
    setTimeout(() => {
        svg.style.opacity = '1';
    }, 100);
}

function createSVGContent() {
    const data = bowtieData;
    
    // Compact layout
    const centerX = 450;
    const centerY = 200;
    const threatX = 100;
    const consequenceX = 800;
    const barrierXLeft = 250;
    const barrierXRight = 650;
    
    let svg = '';
    
    // Connections first
    svg += createConnections(data, centerX, centerY, threatX, consequenceX, barrierXLeft, barrierXRight);
    
    // Nodes
    svg += createCentralEvent(centerX, centerY, data.centralEvent);
    svg += createThreatNodes(data.threats, threatX, centerY);
    svg += createConsequenceNodes(data.consequences, consequenceX, centerY);
    svg += createBarrierNodes(data.preventiveBarriers, barrierXLeft, centerY, 'preventive');
    svg += createBarrierNodes(data.recoveryBarriers, barrierXRight, centerY, 'recovery');
    
    return svg;
}

function createCentralEvent(x, y, title) {
    return `
        <g class="central-event-group" data-id="central-event" data-type="event">
            <rect class="central-event" x="${x - 80}" y="${y - 35}" width="160" height="70" 
                  fill="url(#eventGradient)" filter="url(#dropShadow)"/>
            <text class="node-label" x="${x}" y="${y - 10}" fill="#ffffff">
                ${escapeHtml(truncateText(title, 15))}
            </text>
            <text class="node-subtitle" x="${x}" y="${y + 8}" fill="rgba(255,255,255,0.8)">
                Event
            </text>
        </g>
    `;
}

function createThreatNodes(threats, baseX, centerY) {
    if (threats.length === 0) return '';
    
    const spacing = Math.min(70, 280 / threats.length);
    let svg = '';
    
    threats.forEach((threat, index) => {
        const y = centerY + (index - (threats.length - 1) / 2) * spacing;
        const severityColor = getSeverityColor(threat.severity);
        
        svg += `
            <g class="threat-group" data-id="${threat.id}" data-type="threat">
                <rect class="threat-node" x="${baseX - 60}" y="${y - 25}" width="120" height="50" 
                      style="stroke: ${severityColor};"/>
                <text class="node-label" x="${baseX}" y="${y - 8}">
                    ${escapeHtml(truncateText(threat.title, 12))}
                </text>
                <text class="node-subtitle" x="${baseX}" y="${y + 6}">
                    Threat
                </text>
            </g>
        `;
    });
    
    return svg;
}

function createConsequenceNodes(consequences, baseX, centerY) {
    if (consequences.length === 0) return '';
    
    const spacing = Math.min(70, 280 / consequences.length);
    let svg = '';
    
    consequences.forEach((consequence, index) => {
        const y = centerY + (index - (consequences.length - 1) / 2) * spacing;
        const impactColor = getImpactColor(consequence.impact);
        
        svg += `
            <g class="consequence-group" data-id="${consequence.id}" data-type="consequence">
                <rect class="consequence-node" x="${baseX - 60}" y="${y - 25}" width="120" height="50" 
                      style="stroke: ${impactColor};"/>
                <text class="node-label" x="${baseX}" y="${y - 8}">
                    ${escapeHtml(truncateText(consequence.title, 12))}
                </text>
                <text class="node-subtitle" x="${baseX}" y="${y + 6}">
                    Consequence
                </text>
            </g>
        `;
    });
    
    return svg;
}

function createBarrierNodes(barriers, baseX, centerY, type) {
    if (barriers.length === 0) return '';
    
    const spacing = Math.min(80, 320 / barriers.length);
    let svg = '';
    
    barriers.forEach((barrier, index) => {
        const y = centerY + (index - (barriers.length - 1) / 2) * spacing;
        const statusColor = getStatusColor(barrier.status);
        const barrierType = type === 'preventive' ? 'P' : 'R';
        
        svg += `
            <g class="barrier-group" data-id="${barrier.id}" data-type="barrier">
                <rect class="barrier-node" x="${baseX - 70}" y="${y - 30}" width="140" height="60" 
                      style="stroke: ${statusColor};"/>
                <text class="node-label" x="${baseX}" y="${y - 12}">
                    ${escapeHtml(truncateText(barrier.title, 15))}
                </text>
                <text class="node-subtitle" x="${baseX}" y="${y + 4}">
                    ${barrierType} • ${barrier.status}
                </text>
                <circle class="status-dot" cx="${baseX + 55}" cy="${y - 15}" r="6" 
                        style="fill: ${statusColor};"/>
            </g>
        `;
    });
    
    return svg;
}

function createConnections(data, centerX, centerY, threatX, consequenceX, barrierXLeft, barrierXRight) {
    let svg = '';
    
    // Connect threats to central event
    data.threats.forEach((threat, index) => {
        const y = centerY + (index - (data.threats.length - 1) / 2) * Math.min(70, 280 / data.threats.length);
        svg += `
            <path class="connection-line threat-connection" 
                  d="M ${threatX + 60} ${y} 
                     C ${threatX + 120} ${y}, ${centerX - 60} ${centerY}, ${centerX - 40} ${centerY}"
                  data-from="${threat.id}" data-to="central-event"/>
        `;
    });
    
    // Connect central event to consequences
    data.consequences.forEach((consequence, index) => {
        const y = centerY + (index - (data.consequences.length - 1) / 2) * Math.min(70, 280 / data.consequences.length);
        svg += `
            <path class="connection-line consequence-connection" 
                  d="M ${centerX + 40} ${centerY} 
                     C ${centerX + 60} ${centerY}, ${consequenceX - 120} ${y}, ${consequenceX - 60} ${y}"
                  data-from="central-event" data-to="${consequence.id}"/>
        `;
    });
    
    // Connect preventive barriers
    data.preventiveBarriers.forEach((barrier, index) => {
        const y = centerY + (index - (data.preventiveBarriers.length - 1) / 2) * Math.min(80, 320 / data.preventiveBarriers.length);
        svg += `
            <path class="connection-line barrier-connection preventive" 
                  d="M ${barrierXLeft + 70} ${y} 
                     C ${barrierXLeft + 110} ${y}, ${centerX - 40} ${centerY - 10}, ${centerX - 30} ${centerY - 10}"
                  data-from="${barrier.id}" data-to="central-event"/>
        `;
    });
    
    // Connect recovery barriers
    data.recoveryBarriers.forEach((barrier, index) => {
        const y = centerY + (index - (data.recoveryBarriers.length - 1) / 2) * Math.min(80, 320 / data.recoveryBarriers.length);
        svg += `
            <path class="connection-line barrier-connection recovery" 
                  d="M ${barrierXRight - 70} ${y} 
                     C ${barrierXRight - 110} ${y}, ${centerX + 40} ${centerY + 10}, ${centerX + 30} ${centerY + 10}"
                  data-from="${barrier.id}" data-to="central-event"/>
        `;
    });
    
    return svg;
}

// ==================== INTERACTIVITY ====================

function setupSVGInteractivity() {
    const svg = document.getElementById('bowtieSVG');
    const tooltip = document.getElementById('diagramTooltip');
    
    svg.addEventListener('mouseover', (e) => {
        const node = e.target.closest('[data-type]');
        if (node) {
            const nodeType = node.dataset.type;
            const nodeId = node.dataset.id;
            showNodeTooltip(node, nodeType, nodeId);
        }
    });
    
    svg.addEventListener('mousemove', (e) => {
        if (tooltip.classList.contains('active')) {
            const container = document.getElementById('bowtieContainer');
            const rect = container.getBoundingClientRect();
            
            let x = e.clientX - rect.left + 10;
            let y = e.clientY - rect.top + 10;
            
            if (x + 200 > rect.width) x = e.clientX - rect.left - 210;
            if (y + 120 > rect.height) y = e.clientY - rect.top - 130;
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }
    });
    
    svg.addEventListener('mouseout', (e) => {
        if (!e.relatedTarget || !svg.contains(e.relatedTarget)) {
            hideTooltip();
        }
    });
}

function showNodeTooltip(node, nodeType, nodeId) {
    if (tooltipTimeout) clearTimeout(tooltipTimeout);
    
    const tooltip = document.getElementById('diagramTooltip');
    const title = document.getElementById('tooltipTitle');
    const type = document.getElementById('tooltipType');
    const content = document.getElementById('tooltipContent');
    const meta1 = document.getElementById('tooltipMeta1');
    
    let tooltipData = null;
    
    switch(nodeType) {
        case 'threat':
            tooltipData = bowtieData?.threats.find(t => t.id === nodeId);
            if (tooltipData) {
                title.textContent = tooltipData.title;
                type.textContent = 'Threat';
                type.className = 'tooltip-type type-threat';
                content.textContent = tooltipData.description || 'No description';
                meta1.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>Severity: ${capitalize(tooltipData.severity)}</span>`;
            }
            break;
            
        case 'consequence':
            tooltipData = bowtieData?.consequences.find(c => c.id === nodeId);
            if (tooltipData) {
                title.textContent = tooltipData.title;
                type.textContent = 'Consequence';
                type.className = 'tooltip-type type-consequence';
                content.textContent = tooltipData.description || 'No description';
                meta1.innerHTML = `<i class="fas fa-bolt"></i><span>Impact: ${capitalize(tooltipData.impact)}</span>`;
            }
            break;
            
        case 'barrier':
            tooltipData = [...bowtieData?.preventiveBarriers || [], ...bowtieData?.recoveryBarriers || []]
                .find(b => b.id === nodeId);
            if (tooltipData) {
                title.textContent = tooltipData.title;
                type.textContent = 'Control';
                type.className = 'tooltip-type type-barrier';
                content.textContent = tooltipData.description || 'No description';
                meta1.innerHTML = `<i class="fas fa-tasks"></i><span>Progress: ${tooltipData.progress}%</span>`;
            }
            break;
            
        case 'event':
            title.textContent = bowtieData?.centralEvent || 'Risk Event';
            type.textContent = 'Event';
            type.className = 'tooltip-type type-event';
            content.textContent = bowtieData?.description || 'Central risk event';
            meta1.innerHTML = `<i class="fas fa-flag"></i><span>Risk: ${bowtieData?.riskId || 'Unknown'}</span>`;
            break;
    }
    
    tooltip.classList.add('active');
}

function hideTooltip() {
    tooltipTimeout = setTimeout(() => {
        const tooltip = document.getElementById('diagramTooltip');
        tooltip.classList.remove('active');
    }, 300);
}

// ==================== UTILITIES ====================

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = show ? 'flex' : 'none';
}

function showEmptyState() {
    document.getElementById('bowtieSVG').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('loadingOverlay').style.display = 'none';
}

function updateTitle() {
    const title = document.getElementById('bowtieTitle');
    if (riskData) {
        title.textContent = `Bowtie - ${riskData.riskId || 'Risk'}`;
        document.getElementById('riskTitle').textContent = riskData.title || 'Risk Analysis';
        document.getElementById('riskSubtitle').textContent = riskData.riskId ? `ID: ${riskData.riskId}` : 'Bowtie visualization';
    }
}

function changeView(view) {
    currentView = view;
    
    document.querySelectorAll('.control-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    const svg = document.getElementById('bowtieSVG');
    svg.style.opacity = '0.7';
    
    setTimeout(() => {
        switch(view) {
            case 'threats':
                svg.querySelectorAll('.threat-group').forEach(node => {
                    node.style.opacity = '1';
                });
                svg.querySelectorAll('.consequence-group, .barrier-group').forEach(node => {
                    node.style.opacity = '0.3';
                });
                break;
                
            case 'controls':
                svg.querySelectorAll('.barrier-group').forEach(node => {
                    node.style.opacity = '1';
                });
                svg.querySelectorAll('.threat-group, .consequence-group').forEach(node => {
                    node.style.opacity = '0.3';
                });
                break;
                
            default:
                svg.querySelectorAll('*').forEach(node => {
                    node.style.opacity = '1';
                });
                break;
        }
        
        svg.style.opacity = '1';
    }, 150);
}

function parseCauses(causes) {
    if (!causes) return [];
    
    if (Array.isArray(causes)) {
        return causes.map((cause, index) => ({
            id: `THREAT-${index + 1}`,
            title: cause,
            description: `Cause: ${cause}`,
            severity: calculateThreatSeverity(cause)
        }));
    }
    
    if (typeof causes === 'string') {
        return causes.split(',').map((cause, index) => ({
            id: `THREAT-${index + 1}`,
            title: cause.trim(),
            description: `Cause: ${cause.trim()}`,
            severity: calculateThreatSeverity(cause)
        }));
    }
    
    return [];
}

function parseConsequences(consequences) {
    if (!consequences) return [];
    
    if (Array.isArray(consequences)) {
        return consequences.map((consequence, index) => ({
            id: `CONSEQUENCE-${index + 1}`,
            title: consequence,
            description: `Consequence: ${consequence}`,
            impact: calculateConsequenceImpact(consequence),
            probability: 0.3
        }));
    }
    
    if (typeof consequences === 'string') {
        return consequences.split(',').map((consequence, index) => ({
            id: `CONSEQUENCE-${index + 1}`,
            title: consequence.trim(),
            description: `Consequence: ${consequence.trim()}`,
            impact: calculateConsequenceImpact(consequence),
            probability: 0.3
        }));
    }
    
    return [];
}

function groupActionsByType(actions) {
    const preventiveBarriers = [];
    const recoveryBarriers = [];
    
    actions.forEach((action, index) => {
        const barrier = {
            id: action._id || `ACTION-${index + 1}`,
            title: action.title || 'Untitled Action',
            description: action.description || '',
            status: action.status || 'Proposed',
            owner: action.owner || 'Unassigned',
            progress: action.progress || 0
        };
        
        if (determineActionType(action) === 'preventive') {
            preventiveBarriers.push(barrier);
        } else {
            recoveryBarriers.push(barrier);
        }
    });
    
    return { preventiveBarriers, recoveryBarriers };
}

function calculateThreatSeverity(threat) {
    const threatLower = threat.toLowerCase();
    if (threatLower.includes('critical') || threatLower.includes('major')) {
        return 'High';
    }
    if (threatLower.includes('moderate') || threatLower.includes('medium')) {
        return 'Medium';
    }
    return 'Low';
}

function calculateConsequenceImpact(consequence) {
    const consLower = consequence.toLowerCase();
    if (consLower.includes('fatal') || consLower.includes('catastrophic')) {
        return 'High';
    }
    if (consLower.includes('major') || consLower.includes('significant')) {
        return 'Medium';
    }
    return 'Low';
}

function calculateRiskScore(threats, consequences, preventiveBarriers, recoveryBarriers) {
    const threatCount = threats.length;
    const consequenceCount = consequences.length;
    const barrierCount = preventiveBarriers.length + recoveryBarriers.length;
    
    if (threatCount === 0 || consequenceCount === 0) return 0;
    
    const coverage = Math.min((barrierCount / (threatCount + consequenceCount)) * 100, 100);
    const effectiveBarriers = [...preventiveBarriers, ...recoveryBarriers]
        .filter(b => b.status.toLowerCase() === 'completed').length;
    const effectiveness = barrierCount > 0 ? (effectiveBarriers / barrierCount) * 100 : 0;
    
    return Math.round((coverage * 0.6) + (effectiveness * 0.4));
}

function getSeverityColor(severity) {
    switch(severity.toLowerCase()) {
        case 'high': return 'var(--red)';
        case 'medium': return 'var(--amber)';
        default: return '#94a3b8';
    }
}

function getImpactColor(impact) {
    switch(impact.toLowerCase()) {
        case 'high': return 'var(--amber)';
        case 'medium': return '#f59e0b';
        default: return '#fbbf24';
    }
}

function getStatusColor(status) {
    switch(status?.toLowerCase()) {
        case 'completed': return 'var(--green)';
        case 'in progress': return 'var(--amber)';
        case 'open': return 'var(--blue)';
        default: return 'var(--purple)';
    }
}

function determineActionType(action) {
    const title = (action.title || '').toLowerCase();
    const desc = (action.description || '').toLowerCase();
    const preventiveKeywords = ['prevent', 'avoid', 'stop', 'block', 'mitigate', 'control'];
    const isPreventive = preventiveKeywords.some(kw => title.includes(kw) || desc.includes(kw));
    return isPreventive ? 'preventive' : 'recovery';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function truncateText(text, maxLength) {
    if (!text) return '';
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

function capitalize(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}

// ==================== SAMPLE DATA ====================

function loadSampleData() {
    riskData = {
        _id: 'sample-risk-pro-123',
        riskId: 'RISK-2024-001',
        title: 'Data Security Breach',
        description: 'Unauthorized access to sensitive customer data',
        causes: ['Weak access controls', 'Insufficient MFA', 'Unpatched vulnerabilities', 'Phishing attacks'],
        event: 'Data exfiltration',
        consequences: ['Financial loss', 'Reputation damage', 'Regulatory penalties', 'Customer trust erosion']
    };
    
    currentRiskId = riskData._id;
    
    actions = [
        {
            _id: 'ACTION-P101',
            title: 'Implement MFA',
            description: 'Deploy multi-factor authentication',
            status: 'In Progress',
            progress: 75
        },
        {
            _id: 'ACTION-P102',
            title: 'Security Patching',
            description: 'Regular patch management',
            status: 'Completed',
            progress: 100
        },
        {
            _id: 'ACTION-R101',
            title: 'Incident Response Plan',
            description: 'Emergency response procedures',
            status: 'Open',
            progress: 30
        }
    ];
    
    updateTitle();
    buildBowtieData();
    updateCompactStats();
    renderBowtie();
    
    showToast('Sample data loaded', 'success');
}

function getDefaultBowtieData() {
    return {
        riskId: 'DEMO-001',
        title: 'Sample Risk',
        description: 'Professional bowtie diagram',
        centralEvent: 'Risk Event',
        threats: [
            { id: 'THREAT-1', title: 'Security Vulnerability', severity: 'High', description: 'Critical security issue' },
            { id: 'THREAT-2', title: 'Human Error', severity: 'Medium', description: 'Accidental data exposure' }
        ],
        consequences: [
            { id: 'CONSEQUENCE-1', title: 'Data Breach', impact: 'High', probability: 0.3, description: 'Sensitive data exposure' },
            { id: 'CONSEQUENCE-2', title: 'Financial Loss', impact: 'Medium', probability: 0.4, description: 'Direct financial impact' }
        ],
        preventiveBarriers: [
            { id: 'BARRIER-P1', title: 'Access Controls', status: 'Completed', progress: 100, description: 'Role-based access' },
            { id: 'BARRIER-P2', title: 'Security Monitoring', status: 'In Progress', progress: 75, description: '24/7 monitoring' }
        ],
        recoveryBarriers: [
            { id: 'BARRIER-R1', title: 'Incident Response', status: 'Open', progress: 30, description: 'Emergency procedures' }
        ],
        riskScore: 65
    };
}

// ==================== EVENT HANDLERS ====================

function setupEventListeners() {
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.tooltip') && !e.target.closest('[data-type]')) {
            hideTooltip();
        }
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') hideTooltip();
        if (e.key === 'r' && e.ctrlKey) {
            e.preventDefault();
            refreshDiagram();
        }
    });
}

function goBack() {
    window.history.back();
}

async function refreshDiagram() {
    showToast('Refreshing...', 'info');
    showLoading(true);
    await fetchAllData();
}

function editBowtie() {
    showToast('Edit functionality would open here', 'info');
}

function exportDiagram() {
    const svg = document.getElementById('bowtieSVG');
    const svgData = new XMLSerializer().serializeToString(svg);
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    canvas.width = 900;
    canvas.height = 400;
    
    img.onload = function() {
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        
        const pngData = canvas.toDataURL('image/png');
        const downloadLink = document.createElement('a');
        downloadLink.download = `bowtie-${bowtieData?.riskId || 'diagram'}.png`;
        downloadLink.href = pngData;
        downloadLink.click();
    };
    
    img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
    showToast('Diagram exported', 'success');
}

// ==================== TOAST SYSTEM ====================

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} toast-icon"></i>
        <div class="toast-message">${escapeHtml(message)}</div>
    `;
    
    container.appendChild(toast);
    
    requestAnimationFrame(() => toast.classList.add('show'));
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ==================== GLOBAL EXPORTS ====================

window.goBack = goBack;
window.refreshDiagram = refreshDiagram;
window.editBowtie = editBowtie;
window.exportDiagram = exportDiagram;
window.loadSampleData = loadSampleData;
window.changeView = changeView;
</script>
</body>
</html>