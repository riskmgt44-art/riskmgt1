<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyst Dashboard • RiskMGT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #5DA1A1;
            --primary-hover: #4e9393;
            --green: #10b981;
            --amber: #f59e0b;
            --red: #ef4444;
            --neutral: #6b7280;
            --text-primary: #111111;
            --text-secondary: #555555;
            --bg: #FFFFFF;
            --card-bg: #FFFFFF;
            --border: #e8e8e8;
            --shadow-sm: 0 3.2px 9.6px rgba(0,0,0,0.06);
            --shadow-md: 0 9.6px 25.6px rgba(0,0,0,0.08);
            --radius: 12.8px;
            --transition: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }
        body::-webkit-scrollbar, ::-webkit-scrollbar { display: none; width: 0; height: 0; background: transparent; }
        html, body { -ms-overflow-style: none; scrollbar-width: none; }

        .top-bar {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(8px);
        }
        .top-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .analyst-badge {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .top-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .select-control, .btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            background: var(--bg);
            cursor: pointer;
        }
        .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
        }
        .btn:hover { border-color: var(--primary); color: var(--primary); }
        .refresh-time {
            font-size: 12px;
            color: var(--neutral);
            white-space: nowrap;
        }

        .main {
            flex: 1;
            overflow-y: auto;
            padding: 32px 32px 80px 32px;
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }
        .kpi-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            transition: var(--transition);
        }
        .kpi-card:hover { border-color: var(--primary); }
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .kpi-label {
            font-size: 13px;
            color: var(--neutral);
        }
        .kpi-trend {
            font-size: 12px;
            font-weight: 600;
        }
        .trend-up { color: var(--red); }
        .trend-down { color: var(--green); }
        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 6px;
            transition: color 0.4s ease;
        }
        .kpi-sub {
            font-size: 13px;
            color: var(--neutral);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 48px;
        }
        .chart-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            display: flex;
            flex-direction: column;
        }
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        .chart-container {
            position: relative;
            flex: 1;
            min-height: 320px;
        }

        .secondary-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }

        .attention-panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 24px;
        }
        .attention-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--red);
        }
        .attention-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .attention-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(239,68,68,0.05);
            border-radius: 8px;
            font-size: 14px;
        }
        .attention-empty {
            text-align: center;
            padding: 32px 16px;
            color: var(--neutral);
            font-style: italic;
            font-size: 15px;
        }
        .attention-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        .attention-link:hover { text-decoration: underline; }

        .assets-panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            margin-top: 32px;
        }
        .assets-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .assets-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .assets-count {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        .asset-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: var(--transition);
            /* Removed cursor: pointer */
        }
        .asset-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        .asset-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .asset-category {
            font-size: 12px;
            color: var(--neutral);
            background: rgba(93, 161, 161, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 12px;
        }
        .asset-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }
        .asset-detail {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .asset-detail i {
            color: var(--neutral);
            width: 16px;
        }
        .asset-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 8px;
        }
        .status-healthy { background: rgba(16, 185, 129, 0.1); color: var(--green); }
        .status-warning { background: rgba(245, 158, 11, 0.1); color: var(--amber); }
        .status-critical { background: rgba(239, 68, 68, 0.1); color: var(--red); }

        @media (max-width: 1024px) {
            .analytics-grid { grid-template-columns: 1fr; }
            .assets-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            .top-bar { padding: 16px; flex-direction: column; align-items: stretch; gap: 16px; }
            .top-controls { justify-content: stretch; }
            .select-control, .btn { width: 100%; justify-content: center; }
            .main { padding: 20px 16px 80px 16px; }
            .kpi-row, .secondary-row { grid-template-columns: 1fr; }
            .analytics-grid { gap: 24px; }
            .chart-container { min-height: 280px; }
            .assets-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="top-title">
            Analyst Dashboard
           
        </div>
        <div class="top-controls">
            <select class="select-control" id="asset-filter">
                <option value="all">All Assigned Assets</option>
            </select>
            <button class="btn" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <div class="refresh-time" id="refresh-time">Last updated: —</div>
        </div>
    </div>

    <main class="main">
        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Total Risks in Assigned Assets</div>
                    <div class="kpi-trend" id="risks-trend">—</div>
                </div>
                <div class="kpi-value" id="total-risks">—</div>
                <div class="kpi-sub">Across all assigned assets</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">High Severity Risks</div>
                    <div class="kpi-trend trend-up" id="high-risks-trend">—</div>
                </div>
                <div class="kpi-value" id="high-risks">—</div>
                <div class="kpi-sub">Requiring immediate attention</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Open Actions</div>
                    <div class="kpi-trend" id="actions-trend">—</div>
                </div>
                <div class="kpi-value" id="open-actions">—</div>
                <div class="kpi-sub"><span id="overdue-count">0</span> overdue</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">My Created Risks</div>
                </div>
                <div class="kpi-value" id="my-created-risks">—</div>
                <div class="kpi-sub">Pending approval: <span id="pending-approvals">0</span></div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Assigned Assets</div>
                </div>
                <div class="kpi-value" id="assigned-assets">—</div>
                <div class="kpi-sub">Assets under my responsibility</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">My Recent Activity</div>
                </div>
                <div class="kpi-value" id="recent-activity">—</div>
                <div class="kpi-sub">Last 24 hours</div>
            </div>
        </div>

        <!-- Charts Section - Will show real data -->
        <div class="analytics-grid">
            <div class="chart-card">
                <div class="chart-title">Risk Severity Distribution</div>
                <div class="chart-container">
                    <canvas id="severityChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Risk Trend (Last 7 Days)</div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Action Status Breakdown</div>
                <div class="chart-container">
                    <canvas id="actionChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">My Risk Submissions Status</div>
                <div class="chart-container">
                    <canvas id="submissionsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Attention Required -->
        <div class="attention-panel">
            <div class="attention-title">Attention Required</div>
            <div class="attention-list" id="attention-list">
                <!-- Items will be inserted here dynamically -->
            </div>
            <div id="attention-empty" class="attention-empty" style="display: none;">
                No immediate attention required — all risks and actions are on track.
            </div>
        </div>

        <!-- Assigned Assets -->
        <div class="assets-panel">
            <div class="assets-header">
                <div class="assets-title">My Assigned Assets</div>
                <span class="assets-count" id="assets-count">0</span>
            </div>
            <div class="assets-grid" id="assets-grid">
                <!-- Asset cards will be inserted here -->
            </div>
            <div id="assets-empty" class="attention-empty" style="display: none; margin-top: 16px;">
                No assets assigned to you.
            </div>
        </div>
    </main>

    <script>
        // Chart colors matching your color scheme
        const COLORS = {
            primary: '#5DA1A1',
            red: '#ef4444',
            green: '#10b981',
            amber: '#f59e0b',
            blue: '#3b82f6',
            neutral: '#6b7280'
        };

        // Common chart options
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'bottom', 
                    labels: { 
                        font: { 
                            family: 'Inter', 
                            size: 12 
                        } 
                    } 
                },
                tooltip: { 
                    backgroundColor: 'rgba(0,0,0,0.8)', 
                    titleFont: { family: 'Inter' }, 
                    bodyFont: { family: 'Inter' }, 
                    cornerRadius: 8 
                }
            },
            interaction: { intersect: false, mode: 'index' }
        };

        // Initialize charts with empty data
        let severityChart = null;
        let trendChart = null;
        let actionChart = null;
        let submissionsChart = null;

        // Initialize charts when DOM is ready
        function initializeCharts() {
            // Only initialize if canvas elements exist
            const severityCanvas = document.getElementById('severityChart');
            const trendCanvas = document.getElementById('trendChart');
            const actionCanvas = document.getElementById('actionChart');
            const submissionsCanvas = document.getElementById('submissionsChart');
            
            if (severityCanvas) {
                severityChart = new Chart(severityCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        ...commonOptions,
                        cutout: '70%'
                    }
                });
            }
            
            if (trendCanvas) {
                trendChart = new Chart(trendCanvas, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Risks'
                                }
                            }
                        }
                    }
                });
            }
            
            if (actionCanvas) {
                actionChart = new Chart(actionCanvas, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Actions'
                                }
                            }
                        }
                    }
                });
            }
            
            if (submissionsCanvas) {
                submissionsChart = new Chart(submissionsCanvas, {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: []
                        }]
                    },
                    options: commonOptions
                });
            }
        }

        // API endpoints
        const API_ENDPOINTS = {
            dashboard: '/api/dashboard/analyst',
            assignedAssets: '/api/dashboard/analyst/assigned-assets',
            overview: '/api/dashboard/analyst/overview',
            charts: '/api/dashboard/analyst/charts'
        };

        // Format number with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Update high risks color based on count
        function updateHighRisksColor(count) {
            const element = document.getElementById('high-risks');
            if (!element) return;
            
            if (count >= 30) {
                element.style.color = 'var(--red)';
            } else if (count >= 15) {
                element.style.color = 'var(--amber)';
            } else {
                element.style.color = 'var(--green)';
            }
        }

        // Fetch chart data using the new endpoint
        async function fetchChartData(token) {
            try {
                console.log('Fetching chart data...');
                const chartRes = await fetch(API_ENDPOINTS.charts, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Chart response status:', chartRes.status);
                
                if (chartRes.ok) {
                    const data = await chartRes.json();
                    console.log('Chart data received');
                    return data;
                } else {
                    console.warn('Chart endpoint returned status:', chartRes.status);
                    return null;
                }
                
            } catch (error) {
                console.error('Error fetching chart data:', error);
                return null;
            }
        }

        // Update charts with real data from the new endpoint - FIXED VERSION
        function updateChartsWithRealData(dashboardData, chartData) {
            console.log('Updating charts with data:', { dashboardData, chartData });
            
            // Update severity chart with actual data
            if (severityChart) {
                if (chartData && chartData.severityDistribution) {
                    severityChart.data.labels = chartData.severityDistribution.labels || [];
                    severityChart.data.datasets[0].data = chartData.severityDistribution.values || [];
                    severityChart.data.datasets[0].backgroundColor = chartData.severityDistribution.colors || [
                        COLORS.red, COLORS.amber, COLORS.green
                    ];
                    severityChart.update();
                } else if (dashboardData.totalRisks > 0) {
                    // Fallback to basic data
                    const highCount = dashboardData.highSeverityRisks || 0;
                    const mediumCount = Math.max(0, Math.floor(dashboardData.totalRisks * 0.4));
                    const lowCount = Math.max(0, dashboardData.totalRisks - highCount - mediumCount);
                    
                    severityChart.data.labels = ['High', 'Medium', 'Low'];
                    severityChart.data.datasets[0].data = [highCount, mediumCount, lowCount];
                    severityChart.data.datasets[0].backgroundColor = [COLORS.red, COLORS.amber, COLORS.green];
                    severityChart.update();
                } else {
                    // Show empty state
                    severityChart.data.labels = ['No Data'];
                    severityChart.data.datasets[0].data = [1];
                    severityChart.data.datasets[0].backgroundColor = [COLORS.neutral];
                    severityChart.update();
                }
            }
            
            // Update trend chart with REAL 7-day data - FIXED: Added null check
            if (trendChart) {
                if (chartData && chartData.trendData) {
                    trendChart.data.labels = chartData.trendData.labels || [];
                    trendChart.data.datasets = chartData.trendData.datasets || [];
                    trendChart.update();
                } else if (chartData && chartData.monthlyTrend) {
                    // Alternative: use monthly trend data
                    const labels = Object.keys(chartData.monthlyTrend || {});
                    const values = Object.values(chartData.monthlyTrend || {});
                    
                    trendChart.data.labels = labels;
                    trendChart.data.datasets = [{
                        label: 'Risks',
                        data: values,
                        borderColor: COLORS.primary,
                        backgroundColor: COLORS.primary + '20',
                        tension: 0.4
                    }];
                    trendChart.update();
                } else {
                    // Show empty state
                    trendChart.data.labels = ['No Trend Data'];
                    trendChart.data.datasets = [{
                        label: 'Risks',
                        data: [0],
                        borderColor: COLORS.neutral,
                        backgroundColor: COLORS.neutral + '20'
                    }];
                    trendChart.update();
                }
            }
            
            // Update action chart
            if (actionChart) {
                if (chartData && chartData.actionStatus) {
                    actionChart.data.labels = chartData.actionStatus.labels || [];
                    actionChart.data.datasets = chartData.actionStatus.datasets || [];
                    actionChart.update();
                } else if (dashboardData.openActions > 0) {
                    // Basic action chart as fallback
                    const overdue = dashboardData.overdueActions || 0;
                    const open = Math.max(0, dashboardData.openActions - overdue);
                    
                    actionChart.data.labels = ['Open', 'Overdue'];
                    actionChart.data.datasets = [{
                        label: 'Actions',
                        data: [open, overdue],
                        backgroundColor: [COLORS.primary, COLORS.red]
                    }];
                    actionChart.update();
                } else if (chartData && chartData.statusDistribution) {
                    // Use status distribution if available
                    actionChart.data.labels = Object.keys(chartData.statusDistribution || {});
                    actionChart.data.datasets = [{
                        label: 'Risks by Status',
                        data: Object.values(chartData.statusDistribution || {}),
                        backgroundColor: [COLORS.primary, COLORS.amber, COLORS.green, COLORS.neutral]
                    }];
                    actionChart.update();
                } else {
                    // Show empty state
                    actionChart.data.labels = ['No Action Data'];
                    actionChart.data.datasets = [{
                        label: 'Actions',
                        data: [1],
                        backgroundColor: [COLORS.neutral]
                    }];
                    actionChart.update();
                }
            }
            
            // Update submissions chart (keep using dashboard data as before)
            if (submissionsChart) {
                if (dashboardData.myCreatedRisks > 0) {
                    const approved = dashboardData.myApprovedSubmissions || 0;
                    const pending = dashboardData.myPendingSubmissions || 0;
                    const other = Math.max(0, dashboardData.myCreatedRisks - approved - pending);
                    
                    submissionsChart.data.labels = ['Approved', 'Pending', 'Other'];
                    submissionsChart.data.datasets[0].data = [approved, pending, other];
                    submissionsChart.data.datasets[0].backgroundColor = [COLORS.green, COLORS.amber, COLORS.neutral];
                    submissionsChart.update();
                } else {
                    // Show empty state
                    submissionsChart.data.labels = ['No Submissions'];
                    submissionsChart.data.datasets[0].data = [1];
                    submissionsChart.data.datasets[0].backgroundColor = [COLORS.neutral];
                    submissionsChart.update();
                }
            }
        }

        // Update attention list with real data
        function updateAttentionList(data) {
            const container = document.getElementById('attention-list');
            const emptyMsg = document.getElementById('attention-empty');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            const attentionItems = [];
            
            // Check for overdue actions
            if (data.overdueActions && data.overdueActions > 0) {
                attentionItems.push({
                    title: `${data.overdueActions} overdue action(s) require attention`,
                    action: 'Review Actions',
                    link: '/actions?filter=overdue'
                });
            }
            
            // Check for high severity risks
            if (data.highSeverityRisks && data.highSeverityRisks > 0) {
                attentionItems.push({
                    title: `${data.highSeverityRisks} high severity risks in your assigned assets`,
                    action: 'Review Risks',
                    link: '/risks?filter=high-severity'
                });
            }
            
            // Check for pending approvals
            if (data.myPendingSubmissions && data.myPendingSubmissions > 0) {
                attentionItems.push({
                    title: `${data.myPendingSubmissions} of your risk submissions awaiting approval`,
                    action: 'View Submissions',
                    link: '/risks?filter=my-pending'
                });
            }
            
            // Check for open actions
            if (data.openActions && data.openActions > 0) {
                attentionItems.push({
                    title: `${data.openActions} open actions require follow-up`,
                    action: 'View Actions',
                    link: '/actions?filter=open'
                });
            }
            
            if (attentionItems.length > 0) {
                if (emptyMsg) emptyMsg.style.display = 'none';
                attentionItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'attention-item';
                    div.innerHTML = `
                        <div>${item.title}</div>
                        <a class="attention-link" href="${item.link}">${item.action}</a>
                    `;
                    container.appendChild(div);
                });
            } else {
                if (emptyMsg) emptyMsg.style.display = 'block';
            }
        }

        // Update assigned assets display - REMOVED CLICK HANDLER
        function updateAssetsDisplay(assets) {
            const container = document.getElementById('assets-grid');
            const emptyMsg = document.getElementById('assets-empty');
            const countElement = document.getElementById('assets-count');
            
            if (!container || !countElement) return;
            
            container.innerHTML = '';
            
            if (assets && assets.length > 0) {
                if (emptyMsg) emptyMsg.style.display = 'none';
                countElement.textContent = assets.length.toString();
                
                assets.forEach(asset => {
                    const assetCard = document.createElement('div');
                    assetCard.className = 'asset-card';
                    // REMOVED onclick handler - asset cards are no longer clickable
                    
                    // Determine status class
                    let statusClass = 'status-healthy';
                    let statusText = 'Healthy';
                    
                    if (asset.status === 'inactive') {
                        statusClass = 'status-warning';
                        statusText = 'Inactive';
                    } else if (asset.health === 'Critical' || asset.status === 'critical') {
                        statusClass = 'status-critical';
                        statusText = 'Critical';
                    } else if (asset.health === 'Warning' || asset.status === 'warning') {
                        statusClass = 'status-warning';
                        statusText = 'Warning';
                    }
                    
                    assetCard.innerHTML = `
                        <div class="asset-name">${asset.name || 'Unnamed Asset'}</div>
                        <div class="asset-category">${asset.category || 'Uncategorized'}</div>
                        <div class="asset-details">
                            ${asset.location ? `<div class="asset-detail"><i class="fas fa-map-marker-alt"></i> ${asset.location}</div>` : ''}
                            ${asset.owner ? `<div class="asset-detail"><i class="fas fa-user"></i> ${asset.owner}</div>` : ''}
                            ${asset.updatedAt ? `<div class="asset-detail"><i class="fas fa-clock"></i> Updated: ${new Date(asset.updatedAt).toLocaleDateString()}</div>` : ''}
                        </div>
                        <div class="asset-status ${statusClass}">${statusText}</div>
                    `;
                    
                    container.appendChild(assetCard);
                });
            } else {
                if (emptyMsg) emptyMsg.style.display = 'block';
                countElement.textContent = '0';
            }
        }

        // Main dashboard update function - FIXED VERSION with better error handling
        async function updateDashboard() {
            try {
                console.log('Fetching analyst dashboard data...');
                
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                // Fetch main dashboard data
                const res = await fetch(API_ENDPOINTS.dashboard, {
                    headers: { 
                        'Authorization': `Bearer ${token}`, 
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', res.status);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Server error response:', errorText);
                    throw new Error(`HTTP ${res.status}: ${errorText.substring(0, 100)}`);
                }

                const data = await res.json();
                console.log('Analyst dashboard data received:', data);

                // Update KPIs with real data
                const totalRisksEl = document.getElementById('total-risks');
                const highRisksEl = document.getElementById('high-risks');
                const openActionsEl = document.getElementById('open-actions');
                const overdueCountEl = document.getElementById('overdue-count');
                const myCreatedRisksEl = document.getElementById('my-created-risks');
                const pendingApprovalsEl = document.getElementById('pending-approvals');
                const assignedAssetsEl = document.getElementById('assigned-assets');
                const recentActivityEl = document.getElementById('recent-activity');
                
                if (totalRisksEl) totalRisksEl.textContent = formatNumber(data.totalRisks || 0);
                if (highRisksEl) highRisksEl.textContent = formatNumber(data.highSeverityRisks || 0);
                if (openActionsEl) openActionsEl.textContent = formatNumber(data.openActions || 0);
                if (overdueCountEl) overdueCountEl.textContent = formatNumber(data.overdueActions || 0);
                if (myCreatedRisksEl) myCreatedRisksEl.textContent = formatNumber(data.myCreatedRisks || data.totalMyRisks || 0);
                if (pendingApprovalsEl) pendingApprovalsEl.textContent = formatNumber(data.myPendingSubmissions || 0);
                if (assignedAssetsEl) assignedAssetsEl.textContent = formatNumber(data.assignedAssets || 0);
                if (recentActivityEl) recentActivityEl.textContent = formatNumber(data.recentActivity || data.recentActivity24h || 0);
                
                // Update colors based on real data
                updateHighRisksColor(data.highSeverityRisks || 0);
                
                // Update trend indicators if available
                if (data.totalRisksTrend) {
                    const trendElement = document.getElementById('risks-trend');
                    if (trendElement) {
                        trendElement.textContent = data.totalRisksTrend;
                        trendElement.className = data.totalRisksTrend.includes('+') ? 'kpi-trend trend-up' : 'kpi-trend trend-down';
                    }
                }
                
                if (data.highSeverityTrend) {
                    const trendElement = document.getElementById('high-risks-trend');
                    if (trendElement) {
                        trendElement.textContent = data.highSeverityTrend;
                        trendElement.className = data.highSeverityTrend.includes('+') ? 'kpi-trend trend-up' : 'kpi-trend trend-down';
                    }
                }
                
                // Update Attention Required list with real data
                updateAttentionList(data);
                
                // Fetch and update chart data using the new endpoint
                try {
                    const chartData = await fetchChartData(token);
                    updateChartsWithRealData(data, chartData);
                } catch (chartError) {
                    console.warn('Could not fetch chart data:', chartError);
                    // Update charts with basic data from dashboard response
                    updateChartsWithRealData(data, null);
                }
                
                // Update assigned assets with real data
                if (data.assignedAssetDetails && Array.isArray(data.assignedAssetDetails)) {
                    updateAssetsDisplay(data.assignedAssetDetails);
                } else {
                    // Try to fetch assets separately
                    try {
                        const assetsRes = await fetch(API_ENDPOINTS.assignedAssets, {
                            headers: { 
                                'Authorization': `Bearer ${token}`, 
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (assetsRes.ok) {
                            const assetsData = await assetsRes.json();
                            updateAssetsDisplay(assetsData);
                        } else {
                            updateAssetsDisplay([]);
                        }
                    } catch (assetsError) {
                        console.warn('Could not fetch assets:', assetsError);
                        updateAssetsDisplay([]);
                    }
                }

                // Update timestamp
                const now = new Date();
                const refreshTimeEl = document.getElementById('refresh-time');
                if (refreshTimeEl) {
                    refreshTimeEl.textContent =
                        `Last updated: ${now.toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' })}`;
                }

                console.log('Analyst dashboard updated with real data');

            } catch (err) {
                console.error('Analyst dashboard refresh failed:', err);
                // Update timestamp with error
                const refreshTimeEl = document.getElementById('refresh-time');
                if (refreshTimeEl) {
                    refreshTimeEl.textContent = `Update failed: ${err.message}`;
                }
                
                // Show error in attention panel
                const attentionList = document.getElementById('attention-list');
                const emptyMsg = document.getElementById('attention-empty');
                if (attentionList) {
                    attentionList.innerHTML = '';
                    if (emptyMsg) emptyMsg.style.display = 'none';
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'attention-item';
                    errorDiv.innerHTML = `
                        <div>Unable to load dashboard data: ${err.message}</div>
                        <a class="attention-link" href="#" onclick="updateDashboard();return false;">Retry</a>
                    `;
                    attentionList.appendChild(errorDiv);
                }
                
                // Show empty state for assets
                updateAssetsDisplay([]);
            }
        }

        // Alias for refreshDashboard
        function refreshDashboard() {
            console.log('Manual refresh triggered');
            updateDashboard();
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('Analyst dashboard page loaded, initializing...');
            
            // Initialize charts
            initializeCharts();
            
            // Check for authentication
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No authentication token found');
                const attentionList = document.getElementById('attention-list');
                const emptyMsg = document.getElementById('attention-empty');
                if (attentionList) {
                    attentionList.innerHTML = '';
                    if (emptyMsg) emptyMsg.style.display = 'none';
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'attention-item';
                    errorDiv.innerHTML = `
                        <div>Authentication required. Please log in.</div>
                        <a class="attention-link" href="/login">Login</a>
                    `;
                    attentionList.appendChild(errorDiv);
                }
                return;
            }
            
            updateDashboard();
            
            // Set up auto-refresh every 45 seconds
            setInterval(updateDashboard, 45000);
            
            // Add keyboard shortcut for refresh
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                    e.preventDefault();
                    updateDashboard();
                }
            });
        });

        // Export functions
        window.updateDashboard = updateDashboard;
        window.refreshDashboard = refreshDashboard;
    </script>
</body>
</html>