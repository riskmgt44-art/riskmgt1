<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approvals • RiskMGT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary: #5DA1A1;
            --primary-hover: #4e9393;
            --green: #10b981;
            --red: #ef4444;
            --amber: #f59e0b;
            --neutral: #6b7280;
            --text-primary: #111111;
            --text-secondary: #555555;
            --bg: #FFFFFF;
            --card-bg: #FFFFFF;
            --border: #e8e8e8;
            --shadow-sm: 0 3.2px 9.6px rgba(0,0,0,0.06);
            --shadow-md: 0 9.6px 25.6px rgba(0,0,0,0.08);
            --radius: 12.8px;
            --transition: all 0.3s ease;
            --shimmer-bg: #f6f7f8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
        }
        .main { height: 100%; display: flex; flex-direction: column; }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .search-input {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 9px;
            font-size: 13px;
            width: 340px;
            background: #fafafa;
        }
        .filter-actions { display: flex; gap: 12px; }
        .nav-btn {
            padding: 9px 18px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 9px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
        }
        .nav-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* KPI Row */
        .kpi-row {
            display: flex;
            gap: 16px;
            padding: 20px 32px;
            overflow-x: auto;
            background: var(--bg);
        }
        .kpi-card {
            flex: 1;
            min-width: 210px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 18px 20px;
            cursor: pointer;
            transition: var(--transition);
        }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .kpi-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(93,161,161,0.1);
        }
        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .kpi-label {
            font-size: 13px;
            color: var(--neutral);
        }

        /* Table & Cards Container */
        .content-area {
            flex: 1;
            overflow: hidden;
            padding: 0 32px 32px;
        }
        .table-container {
            height: 100%;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            overflow: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        thead {
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 8;
        }
        th {
            text-align: left;
            padding: 14px 16px;
            font-weight: 600;
            color: var(--neutral);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
        }
        tbody tr:hover { background: rgba(93,161,161,0.04); }
        .type-pill, .status-pill {
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 11.5px;
            font-weight: 600;
        }
        .type-risk    { background: rgba(93,161,161,0.1); color: var(--primary); }
        .type-action  { background: rgba(59,130,246,0.1); color: #3b82f6; }
        .type-ram     { background: rgba(245,158,11,0.1); color: var(--amber); }
        .type-user    { background: rgba(168,85,247,0.1); color: #a855f7; }
        .type-policy  { background: rgba(34,197,94,0.1); color: #22c55e; }
        .type-asset   { background: rgba(249,115,22,0.1); color: #f97316; }
        .status-pending { background: rgba(245,158,11,0.1); color: var(--amber); }
        .status-approved { background: rgba(16,185,129,0.1); color: var(--green); }
        .status-rejected { background: rgba(239,68,68,0.1); color: var(--red); }
        .sla-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11.5px;
        }
        .sla-normal   { background: #f1f5f9; color: var(--neutral); }
        .sla-warning  { background: rgba(245,158,11,0.1); color: var(--amber); }
        .sla-breach   { background: rgba(239,68,68,0.1); color: var(--red); }
        .action-btns { display: flex; gap: 8px; }
        .btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }
        .btn-approve { background: var(--green); color: white; border: none; }
        .btn-approve:hover { background: #059669; }
        .btn-reject  { background: var(--red); color: white; border: none; }
        .btn-reject:hover  { background: #dc2626; }
        .btn-view    { background: transparent; border: 1px solid var(--border); color: var(--neutral); }
        .btn-view:hover    { border-color: var(--primary); color: var(--primary); }

        /* Skeleton */
        .skeleton {
            background: var(--shimmer-bg);
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }
        .skeleton::before {
            content: '';
            position: absolute;
            top: 0; left: -150%;
            width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.9) 50%, transparent 100%);
            animation: shimmer 1.4s infinite;
        }
        @keyframes shimmer { 0% { left: -150%; } 100% { left: 150%; } }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            width: 620px;
            max-width: 92%;
            max-height: 92vh;
            overflow-y: auto;
            padding: 28px;
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 16px;
            right: 20px;
            background: transparent;
            border: none;
            font-size: 22px;
            color: var(--neutral);
            cursor: pointer;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* Mobile Cards */
        .cards-container {
            padding: 16px;
            overflow-y: auto;
        }
        .approval-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 18px;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .filter-bar { flex-direction: column; gap: 12px; padding: 16px; }
            .search-input { width: 100%; }
            .kpi-row { flex-direction: column; padding: 16px; }
            .table-container { display: none; }
            .cards-container { display: block; }
        }
        @media (min-width: 769px) {
            .cards-container { display: none; }
        }
    </style>
</head>
<body>

<div class="main">
    <div class="filter-bar">
        <input type="text" id="searchInput" class="search-input" placeholder="Search by ID, title, owner...">
        <div class="filter-actions">
            <button class="nav-btn" id="filterBtn"><i class="fas fa-filter"></i> Filter</button>
            <button class="nav-btn" id="exportBtn"><i class="fas fa-file-export"></i> Export</button>
            <button class="nav-btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
    </div>

    <div class="kpi-row">
        <div class="kpi-card active" id="kpiPending">
            <div class="kpi-value" style="color: var(--amber);">0</div>
            <div class="kpi-label">Pending Approvals</div>
        </div>
        <div class="kpi-card" id="kpiApproved">
            <div class="kpi-value" style="color: var(--green);">0</div>
            <div class="kpi-label">Approved Today</div>
        </div>
        <div class="kpi-card" id="kpiRejected">
            <div class="kpi-value" style="color: var(--red);">0</div>
            <div class="kpi-label">Rejected Today</div>
        </div>
        <div class="kpi-card" id="kpiAvgTime">
            <div class="kpi-value">—</div>
            <div class="kpi-label">Avg Approval Time</div>
        </div>
        <div class="kpi-card" id="kpiTotal">
            <div class="kpi-value" style="color: var(--primary);">0</div>
            <div class="kpi-label">Total Approvals</div>
        </div>
    </div>

    <div class="content-area">
        <!-- Desktop Table -->
        <div class="table-container">
            <table id="approvalsTable">
                <thead>
                    <tr>
                        <th class="checkbox"><input type="checkbox" id="selectAll"></th>
                        <th>Type</th>
                        <th>ID</th>
                        <th>Title / Description</th>
                        <th>Requested Change</th>
                        <th>Requested By</th>
                        <th>Owner</th>
                        <th>Sub Project</th>
                        <th>Status</th>
                        <th>Submitted</th>
                        <th>SLA</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <!-- Mobile Cards -->
        <div class="cards-container" id="cardsContainer"></div>
    </div>

    <!-- Modal - Updated for Analyst (View Only) -->
    <div class="modal" id="approvalModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div class="modal-title" id="modalTitle">Approval Details (View Only)</div>

            <div class="modal-section">
                <div class="modal-label">Context</div>
                <div id="modalContext"></div>
            </div>

            <div class="modal-section">
                <div class="modal-label">Change Details</div>
                <table class="diff-table" id="diffTable">
                    <thead><tr><th>Field</th><th>Old</th><th>New</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="modal-section">
                <div class="modal-label">Approval History</div>
                <div id="modalHistory" style="font-size: 13px; line-height: 1.6;"></div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-view" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let approvalsData = [];
let currentFilter = 'all';
let currentApprovalId = null;
let currentUser = null;

// Main initialization
document.addEventListener('DOMContentLoaded', () => {
    // Setup event listeners
    setupEventListeners();
    
    // Load user info
    loadCurrentUser();
    
    // Fetch initial data
    fetchApprovals();
});

function setupEventListeners() {
    // Search input
    document.getElementById('searchInput').addEventListener('input', debounce((e) => {
        filterApprovals(e.target.value.trim());
    }, 300));
    
    // Select all checkbox
    document.getElementById('selectAll').addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = e.target.checked);
    });
    
    // Buttons
    document.getElementById('refreshBtn').addEventListener('click', fetchApprovals);
    document.getElementById('filterBtn').addEventListener('click', showAnalystFilterOptions);
    document.getElementById('exportBtn').addEventListener('click', exportApprovals);
    
    // KPI card clicks
    document.querySelectorAll('.kpi-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Close modal when clicking outside
    document.getElementById('approvalModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('approvalModal')) {
            closeModal();
        }
    });
}

function loadCurrentUser() {
    // Simulate getting current user info
    setTimeout(() => {
        currentUser = {
            id: 'analyst_001',
            name: 'Sarah Analyst',
            email: 'analyst@companymgt.com',
            department: 'Risk Analysis',
            role: 'analyst',
            permissions: ['view_approvals', 'export_data', 'read_only']
        };
    }, 100);
}

async function fetchApprovals() {
    showSkeleton();
    
    try {
        const token = getToken();
        if (!token) {
            showEmptyState('Authentication Required', 'Please login to view approvals');
            return;
        }
        
        const response = await fetch('/api/approvals', {
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.status === 401) {
            showEmptyState('Session Expired', 'Please login again');
            return;
        }
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.approvals) {
            approvalsData = data.approvals;
            console.log('✅ Fetched approvals:', approvalsData.length, 'items');
            
            renderApprovals(approvalsData);
            updateKPIsFromData(approvalsData);
        } else {
            showEmptyState('No Approvals', 'No approval records found');
            resetKPIs();
        }
    } catch (err) {
        console.error('Error fetching approvals:', err);
        showEmptyState('Connection Error', 'Failed to load approvals. Please try again.');
        resetKPIs();
    }
}

function showSkeleton() {
    const tableBody = document.getElementById('tableBody');
    const cardsContainer = document.getElementById('cardsContainer');
    
    tableBody.innerHTML = '';
    cardsContainer.innerHTML = '';
    
    for (let i = 0; i < 7; i++) {
        // Table skeleton
        const tr = document.createElement('tr');
        tr.className = 'skeleton-row';
        tr.innerHTML = `
            <td><div class="skeleton" style="height:20px;width:20px;"></div></td>
            <td><div class="skeleton" style="height:24px;width:80px;border-radius:999px;"></div></td>
            <td><div class="skeleton" style="height:20px;width:90px;"></div></td>
            <td><div class="skeleton" style="height:20px;width:280px;"></div></td>
            <td><div class="skeleton" style="height:20px;width:160px;"></div></td>
            <td><div class="skeleton" style="height:20px;width:140px;"></div></td>
            <td><div class="skeleton" style="height:20px;width:120px;"></div></td>
            <td><div class="skeleton" style="height:20px;width:110px;"></div></td>
            <td><div class="skeleton" style="height:24px;width:90px;border-radius:999px;"></div></td>
            <td><div class="skeleton" style="height:20px;width:130px;"></div></td>
            <td><div class="skeleton" style="height:24px;width:100px;border-radius:6px;"></div></td>
            <td><div class="skeleton" style="height:28px;width:140px;"></div></td>
        `;
        tableBody.appendChild(tr);
        
        // Card skeleton
        const card = document.createElement('div');
        card.className = 'approval-card skeleton';
        card.style.height = '180px';
        cardsContainer.appendChild(card);
    }
}

function renderApprovals(items) {
    const tableBody = document.getElementById('tableBody');
    const cardsContainer = document.getElementById('cardsContainer');
    
    // Clear current content
    tableBody.innerHTML = '';
    cardsContainer.innerHTML = '';
    
    if (!items || items.length === 0) {
        if (currentFilter !== 'all' || document.getElementById('searchInput').value.trim()) {
            showEmptyState('No Results', 'No approvals match your criteria');
        } else {
            showEmptyState('No Approvals', 'No approval records found');
        }
        return;
    }
    
    let pending = 0, approvedToday = 0, rejectedToday = 0;
    
    items.forEach(item => {
        if (item.status === 'pending') pending++;
        
        // Check if approved/rejected today
        const today = new Date().toISOString().split('T')[0];
        if (item.status === 'approved' && item.processedAt && item.processedAt.includes(today)) {
            approvedToday++;
        }
        if (item.status === 'rejected' && item.processedAt && item.processedAt.includes(today)) {
            rejectedToday++;
        }
        
        // Table row - Analyst view only shows View button
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="checkbox"></td>
            <td><span class="type-pill type-${item.type?.toLowerCase() || 'risk'}">${escapeHtml(item.type || 'Risk')}</span></td>
            <td><a class="id-link" href="#" onclick="viewDetails('${escapeHtml(item._id)}')">${escapeHtml(item._id ? item._id.substring(0, 8) : '—')}</a></td>
            <td>${escapeHtml(item.title || '—')}</td>
            <td class="diff">${escapeHtml(getChangeDescription(item) || '—')}</td>
            <td>${escapeHtml(item.submittedByEmail || item.submittedBy || '—')}</td>
            <td>${escapeHtml(item.owner || '—')}</td>
            <td>${escapeHtml(item.subProject || '—')}</td>
            <td><span class="status-pill status-${item.status || 'pending'}">${escapeHtml(item.status?.charAt(0).toUpperCase() + item.status?.slice(1) || 'Pending')}</span></td>
            <td>${escapeHtml(item.submittedAt ? formatDate(item.submittedAt) : '—')}</td>
            <td><span class="sla-badge sla-${calculateSLAStatus(item)}">${getSLAText(calculateSLAStatus(item))}</span></td>
            <td class="action-btns">
                <button class="btn btn-view" onclick="viewDetails('${escapeHtml(item._id)}')">
                    <i class="fas fa-eye"></i> View
                </button>
            </td>
        `;
        tableBody.appendChild(tr);
        
        // Mobile card - Analyst view only
        const card = document.createElement('div');
        card.className = 'approval-card';
        card.innerHTML = `
            <div class="card-header">
                <span class="type-pill type-${item.type?.toLowerCase() || 'risk'}">${escapeHtml(item.type || 'Risk')}</span>
                <span class="status-pill status-${item.status || 'pending'}">${escapeHtml(item.status?.charAt(0).toUpperCase() + item.status?.slice(1) || 'Pending')}</span>
            </div>
            <div class="card-title">${escapeHtml(item._id ? item._id.substring(0, 8) : '—')}: ${escapeHtml(item.title || '—')}</div>
            <div class="card-desc">${escapeHtml(getChangeDescription(item) || '—')}</div>
            <div class="card-meta">Requested By: ${escapeHtml(item.submittedByEmail || item.submittedBy || '—')} • ${escapeHtml(item.submittedAt ? formatDate(item.submittedAt) : '—')}</div>
            <div class="card-meta">Owner: ${escapeHtml(item.owner || '—')} • Sub: ${escapeHtml(item.subProject || '—')}</div>
            <div class="card-meta">SLA: <span class="sla-badge sla-${calculateSLAStatus(item)}">${getSLAText(calculateSLAStatus(item))}</span></div>
            <div class="card-actions">
                <button class="btn btn-view" onclick="viewDetails('${escapeHtml(item._id)}')">
                    <i class="fas fa-eye"></i> View Details
                </button>
            </div>
        `;
        cardsContainer.appendChild(card);
    });
    
    // Update KPIs
    document.getElementById('kpiPending').querySelector('.kpi-value').textContent = pending;
    document.getElementById('kpiApproved').querySelector('.kpi-value').textContent = approvedToday;
    document.getElementById('kpiRejected').querySelector('.kpi-value').textContent = rejectedToday;
    document.getElementById('kpiTotal').querySelector('.kpi-value').textContent = items.length;
    
    // Calculate average time
    updateAvgTimeKPIs(items);
}

function updateKPIsFromData(data) {
    if (!data || data.length === 0) {
        resetKPIs();
        return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    
    let pending = 0;
    let approvedToday = 0;
    let rejectedToday = 0;
    let total = data.length;
    
    data.forEach(approval => {
        const status = approval.status || 'pending';
        
        if (status === 'pending') {
            pending++;
        } else if (status === 'approved') {
            // Check if approved today
            if (approval.processedAt && typeof approval.processedAt === 'string') {
                const processedDate = approval.processedAt.split('T')[0];
                if (processedDate === today) {
                    approvedToday++;
                }
            }
        } else if (status === 'rejected') {
            // Check if rejected today
            if (approval.processedAt && typeof approval.processedAt === 'string') {
                const processedDate = approval.processedAt.split('T')[0];
                if (processedDate === today) {
                    rejectedToday++;
                }
            }
        }
    });
    
    // Update KPI values
    document.getElementById('kpiPending').querySelector('.kpi-value').textContent = pending;
    document.getElementById('kpiApproved').querySelector('.kpi-value').textContent = approvedToday;
    document.getElementById('kpiRejected').querySelector('.kpi-value').textContent = rejectedToday;
    document.getElementById('kpiTotal').querySelector('.kpi-value').textContent = total;
    
    // Calculate average time
    updateAvgTimeKPIs(data);
}

function updateAvgTimeKPIs(data) {
    let totalProcessingTime = 0;
    let processedCount = 0;
    
    data.forEach(approval => {
        // Calculate processing time for processed approvals
        if ((approval.status === 'approved' || approval.status === 'rejected') &&
            approval.submittedAt && approval.processedAt) {
            try {
                const submitted = new Date(approval.submittedAt);
                const processed = new Date(approval.processedAt);
                const processingTime = processed - submitted; // in milliseconds
                
                if (!isNaN(processingTime) && processingTime > 0) {
                    totalProcessingTime += processingTime;
                    processedCount++;
                }
            } catch (e) {
                console.log('Error calculating processing time:', e);
            }
        }
    });
    
    // Calculate and update average time
    let avgTimeText = '—';
    if (processedCount > 0) {
        const avgMs = totalProcessingTime / processedCount;
        const avgHours = avgMs / (1000 * 60 * 60);
        
        if (avgHours < 1) {
            const minutes = Math.round(avgHours * 60);
            avgTimeText = `${minutes}m`;
        } else if (avgHours < 24) {
            avgTimeText = `${avgHours.toFixed(1)}h`;
        } else {
            avgTimeText = `${(avgHours / 24).toFixed(1)}d`;
        }
    }
    
    document.getElementById('kpiAvgTime').querySelector('.kpi-value').textContent = avgTimeText;
}

function resetKPIs() {
    document.getElementById('kpiPending').querySelector('.kpi-value').textContent = '0';
    document.getElementById('kpiApproved').querySelector('.kpi-value').textContent = '0';
    document.getElementById('kpiRejected').querySelector('.kpi-value').textContent = '0';
    document.getElementById('kpiAvgTime').querySelector('.kpi-value').textContent = '—';
    document.getElementById('kpiTotal').querySelector('.kpi-value').textContent = '0';
}

function filterByStatus(status) {
    currentFilter = status;
    let filtered = approvalsData;
    
    if (status !== 'all') {
        filtered = approvalsData.filter(a => a.status === status);
    }
    
    renderApprovals(filtered);
    
    // Update active KPI card
    document.querySelectorAll('.kpi-card').forEach(card => card.classList.remove('active'));
    if (status === 'pending') {
        document.getElementById('kpiPending').classList.add('active');
    } else if (status === 'approved') {
        document.getElementById('kpiApproved').classList.add('active');
    } else if (status === 'rejected') {
        document.getElementById('kpiRejected').classList.add('active');
    } else {
        document.getElementById('kpiTotal').classList.add('active');
    }
}

function filterApprovals(searchTerm) {
    if (!searchTerm) {
        filterByStatus(currentFilter);
        return;
    }
    
    const term = searchTerm.toLowerCase();
    const filtered = approvalsData.filter(item => {
        return (
            (item._id && item._id.toLowerCase().includes(term)) ||
            (item.title && item.title.toLowerCase().includes(term)) ||
            (item.type && item.type.toLowerCase().includes(term)) ||
            (item.submittedBy && item.submittedBy.toLowerCase().includes(term)) ||
            (item.submittedByEmail && item.submittedByEmail.toLowerCase().includes(term)) ||
            (item.owner && item.owner.toLowerCase().includes(term)) ||
            (item.description && item.description.toLowerCase().includes(term))
        );
    });
    
    renderApprovals(filtered);
}

function getChangeDescription(item) {
    if (item.additionalData && item.additionalData.changeDescription) {
        return item.additionalData.changeDescription;
    }
    
    if (item.type === 'risk_submission' && item.riskTitle) {
        return `New risk: ${item.riskTitle}`;
    }
    
    if (item.entityType && item.entityId) {
        return `${item.entityType} update`;
    }
    
    return item.type === 'user_create' ? 'New user creation' : 
           item.type === 'policy_change' ? 'Policy update' : 
           item.type === 'asset' ? 'Asset modification' : 'Change request';
}

function viewDetails(approvalId) {
    const item = approvalsData.find(a => a._id === approvalId);
    if (!item) return;
    
    currentApprovalId = approvalId;
    
    // Populate modal for Analyst (view only)
    document.getElementById('modalTitle').textContent = `Approval Details: ${approvalId.substring(0, 8)}`;
    document.getElementById('modalContext').innerHTML = `
        <strong>Type:</strong> ${formatType(item.type)}<br>
        <strong>Title:</strong> ${escapeHtml(item.title)}<br>
        <strong>Submitted By:</strong> ${escapeHtml(item.submittedByEmail || item.submittedBy || 'Unknown')}<br>
        <strong>Submitted:</strong> ${item.submittedAt ? formatDateTime(item.submittedAt) : '—'}<br>
        <strong>Status:</strong> ${formatStatus(item.status)}<br>
        ${item.processedBy ? `<strong>Processed By:</strong> ${escapeHtml(item.processedByEmail || item.processedBy || 'Unknown')}<br>` : ''}
        ${item.processedAt ? `<strong>Processed:</strong> ${formatDateTime(item.processedAt)}<br>` : ''}
        ${item.comment ? `<strong>Comment:</strong> ${escapeHtml(item.comment)}<br>` : ''}
    `;
    
    // Populate diff table
    const diffTable = document.querySelector('#diffTable tbody');
    diffTable.innerHTML = '';
    
    if (item.additionalData && item.additionalData.changes) {
        Object.entries(item.additionalData.changes).forEach(([field, change]) => {
            const row = diffTable.insertRow();
            row.innerHTML = `
                <td>${escapeHtml(field)}</td>
                <td>${escapeHtml(change.old || '—')}</td>
                <td>${escapeHtml(change.new || '—')}</td>
            `;
        });
    } else {
        diffTable.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--neutral);">No change details available</td></tr>';
    }
    
    // Populate approval history
    const historyDiv = document.getElementById('modalHistory');
    let historyHTML = '';
    
    // Submitted event
    historyHTML += `
        <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
            <div style="font-weight: 600; color: var(--primary);">Submitted</div>
            <div style="font-size: 12px; color: var(--neutral);">${item.submittedAt ? formatDateTime(item.submittedAt) : 'Unknown'}</div>
            <div>By: ${escapeHtml(item.submittedByEmail || item.submittedBy || 'Unknown')}</div>
        </div>
    `;
    
    // History entries
    if (item.history && Array.isArray(item.history)) {
        item.history.forEach((entry, index) => {
            historyHTML += `
                <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                    <div style="font-weight: 600; color: ${entry.action === 'approved' ? 'var(--green)' : 'var(--red)'};">Level ${entry.level || 1} ${entry.action || 'processed'}</div>
                    <div style="font-size: 12px; color: var(--neutral);">${entry.approvedAt ? formatDateTime(entry.approvedAt) : 'Unknown'}</div>
                    <div>By: ${escapeHtml(entry.approvedBy || 'Unknown')}</div>
                    ${entry.comment ? `<div>Comment: ${escapeHtml(entry.comment)}</div>` : ''}
                </div>
            `;
        });
    }
    
    // Final decision if processed
    if (item.status !== 'pending' && item.processedAt) {
        historyHTML += `
            <div style="margin-bottom: 12px;">
                <div style="font-weight: 600; color: ${item.status === 'approved' ? 'var(--green)' : 'var(--red)'};">Final Decision: ${formatStatus(item.status)}</div>
                <div style="font-size: 12px; color: var(--neutral);">${formatDateTime(item.processedAt)}</div>
                <div>By: ${escapeHtml(item.processedByEmail || item.processedBy || 'Unknown')}</div>
            </div>
        `;
    }
    
    historyDiv.innerHTML = historyHTML || '<div style="color: var(--neutral); text-align: center;">No history available</div>';
    
    // Show modal
    document.getElementById('approvalModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('approvalModal').style.display = 'none';
    currentApprovalId = null;
}

function showAnalystFilterOptions() {
    const options = `
Analyst Filter Options:
• All (Default)
• Pending
• Approved
• Rejected
• By Type (Risk/Action/Access/Policy/Asset)
• By Department
• By Time Range (Today/This Week/This Month)

Note: As an Analyst, you have view-only access.
    `;
    alert(options);
}

function exportApprovals() {
    if (approvalsData.length === 0) {
        alert('No approvals to export.');
        return;
    }
    
    // Export as CSV for analyst reporting
    const headers = ['ID', 'Type', 'Title', 'Status', 'Submitted By', 'Submitted At', 
                     'Processed By', 'Processed At', 'Owner', 'Sub Project', 'Comment'];
    const csvRows = [];
    
    csvRows.push(headers.join(','));
    
    approvalsData.forEach(item => {
        const row = [
            item._id,
            item.type,
            `"${escapeCsv(item.title)}"`,
            item.status,
            `"${escapeCsv(item.submittedByEmail || item.submittedBy || '')}"`,
            item.submittedAt || '',
            `"${escapeCsv(item.processedByEmail || item.processedBy || '')}"`,
            item.processedAt || '',
            `"${escapeCsv(item.owner || '')}"`,
            `"${escapeCsv(item.subProject || '')}"`,
            `"${escapeCsv(item.comment || '')}"`
        ];
        csvRows.push(row.join(','));
    });
    
    const csvContent = csvRows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `approvals_analyst_report_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function calculateSLAStatus(item) {
    if (item.status !== 'pending') return 'normal';
    
    if (!item.submittedAt) return 'normal';
    
    try {
        const submitted = new Date(item.submittedAt);
        const now = new Date();
        const hoursDiff = (now - submitted) / (1000 * 60 * 60);
        
        if (hoursDiff > 72) return 'breach';    // Over 3 days
        if (hoursDiff > 48) return 'warning';   // 2-3 days
        return 'normal';                        // Less than 2 days
    } catch (e) {
        return 'normal';
    }
}

function getSLAText(status) {
    switch(status) {
        case 'breach': return 'SLA Breach';
        case 'warning': return 'Approaching SLA';
        default: return 'Within SLA';
    }
}

function formatDate(dateString) {
    if (!dateString) return '—';
    
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '—';
        
        const now = new Date();
        const diffHours = (now - date) / (1000 * 60 * 60);
        
        if (diffHours < 1) {
            return 'Just now';
        } else if (diffHours < 24) {
            const hours = Math.floor(diffHours);
            return `${hours}h ago`;
        } else if (diffHours < 48) {
            return 'Yesterday';
        } else if (diffHours < 168) {
            const days = Math.floor(diffHours / 24);
            return `${days}d ago`;
        } else {
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }
    } catch (e) {
        return '—';
    }
}

function formatDateTime(dateString) {
    if (!dateString) return '—';
    
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '—';
        
        return date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return '—';
    }
}

function formatType(type) {
    if (!type) return 'Risk';
    
    return type
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

function formatStatus(status) {
    if (!status) return 'Pending';
    return status.charAt(0).toUpperCase() + status.slice(1);
}

function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function escapeCsv(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/"/g, '""');
}

function getToken() {
    return localStorage.getItem('token') || sessionStorage.getItem('token');
}

function showEmptyState(title, message) {
    const tableBody = document.getElementById('tableBody');
    const cardsContainer = document.getElementById('cardsContainer');
    
    const msg = `
        <div style="text-align:center;padding:120px 20px;color:var(--text-secondary);">
            <i class="fas fa-inbox" style="font-size:64px;opacity:0.4;margin-bottom:24px;"></i><br>
            <div style="font-size:18px;font-weight:500;">${title}</div>
            <div style="font-size:14px;margin-top:8px;">${message}</div>
        </div>`;
    
    tableBody.innerHTML = `<tr><td colspan="12">${msg}</td></tr>`;
    cardsContainer.innerHTML = msg;
    
    resetKPIs();
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
</body>
</html>