<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Risks • RiskMGT Analyst</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary: #5DA1A1;
            --primary-hover: #4e9393;
            --green: #10b981;
            --red: #ef4444;
            --amber: #f59e0b;
            --blue: #3b82f6;
            --neutral: #6b7280;
            --text-primary: #111111;
            --text-secondary: #555555;
            --bg: #FFFFFF;
            --card-bg: #FFFFFF;
            --border: #e8e8e8;
            --shadow-sm: 0 3.2px 9.6px rgba(0,0,0,0.06);
            --shadow-md: 0 9.6px 25.6px rgba(0,0,0,0.08);
            --radius: 12.8px;
            --transition: all 0.3s ease;
            --shimmer-bg: #f6f7f8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
        }

        /* Shimmer Skeleton */
        .skeleton {
            background: var(--shimmer-bg);
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }
        .skeleton::before {
            content: '';
            position: absolute;
            top: 0; left: -150%;
            width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.9) 50%, transparent 100%);
            animation: shimmer 1.2s infinite linear;
            transform: skewX(-20deg);
        }
        @keyframes shimmer { 0% { left: -150%; } 100% { left: 150%; } }

        /* Top Nav */
        .top-nav {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 10;
        }
        .tabs-group { display: flex; align-items: center; gap: 8px; }
        .nav-tab {
            padding: 0 20px;
            height: 40px;
            background: rgba(93,161,161,0.08);
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }
        .nav-tab.active {
            background: var(--card-bg);
            color: var(--text-primary);
            font-weight: 600;
            border-bottom: 3px solid var(--primary);
        }
        .nav-tab:hover:not(.active) { background: rgba(93,161,161,0.15); }
        .nav-tab.disabled {
            cursor: default;
            opacity: 0.5;
        }
        .nav-tab.disabled:hover {
            background: rgba(93,161,161,0.08);
        }
        .nav-tab .favicon {
            width: 16px; height: 16px; background: var(--primary); border-radius: 4px;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 10px;
        }
        .actions-group { display: flex; align-items: center; gap: 19.2px; }
        .search-box input {
            padding: 8px 12.8px; border: 1px solid var(--border); border-radius: 9.6px;
            width: 320px; font-size: 12px; background: #f9f9f9;
        }
        .btn-icon {
            width: 36px; height: 36px; border-radius: 9.6px; background: transparent;
            border: 1px solid var(--border); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: var(--transition);
        }
        .btn-icon:hover { background: rgba(93,161,161,0.06); color: var(--primary); }
        .btn-primary {
            padding: 8px 16px; background: var(--primary); color: white; border: none;
            border-radius: 9.6px; font-size: 12px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: var(--transition);
        }
        .btn-primary:hover { background: var(--primary-hover); }
        
        /* Button Loading State */
        .btn-primary.loading {
            position: relative;
            color: transparent;
        }
        .btn-primary.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: button-spin 0.8s linear infinite;
        }
        
        @keyframes button-spin {
            to { transform: rotate(360deg); }
        }

        /* Main Layout */
        .main { position: fixed; top: 64px; left: 0; right: 0; bottom: 0; overflow: hidden; }
        .content-wrapper { width: 100%; height: 100%; overflow: hidden; position: relative; }
        .page-content { display: none; height: 100%; overflow: auto; }

        /* Table View */
        .table-view { display: block; height: 100%; padding: 24px; }
        .table-container {
            width: 100%; height: 100%;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            overflow: auto;
        }
        .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
        .table-container::-webkit-scrollbar-track { background: rgba(93,161,161,0.05); border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        table { min-width: 2400px; width: 100%; border-collapse: collapse; }
        thead { position: sticky; top: 0; background: var(--card-bg); z-index: 8; }
        th { padding: 12.8px 16px; font-size: 11.2px; font-weight: 600; color: var(--text-secondary);
             border-bottom: 1px solid var(--border); text-align: left; white-space: nowrap; }
        td { padding: 12.8px 16px; font-size: 12.8px; border-bottom: 1px solid var(--border); white-space: nowrap; }
        tbody tr:hover { background: rgba(93,161,161,0.03); }

        /* Skeleton */
        .skeleton-row td { padding: 16px; }
        .skeleton-cell { height: 20px; width: 80%; border-radius: 4px; }
        .skeleton-cell.short { width: 50%; }
        .skeleton-pill { height: 24px; width: 90px; border-radius: 999px; }

        /* Mobile Cards */
        .card-view { display: none; padding: 16px; overflow-y: auto; height: 100%; }
        .risk-card {
            background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-sm);
        }
        .risk-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .risk-card-title { font-size: 16px; font-weight: 600; cursor: pointer; }
        .risk-card-title:hover { color: var(--primary); }
        .risk-card-grid { display: grid; grid-template-columns: 140px 1fr; gap: 8px 16px; font-size: 13px; }
        .risk-card-label { color: var(--text-secondary); font-weight: 500; }

        /* Pills & Arrows */
        .pill { padding: 4px 9.6px; border-radius: 999px; font-size: 10.4px; font-weight: 600; }
        .pill-downside { background: rgba(239,68,68,0.1); color: var(--red); }
        .pill-upside { background: rgba(16,185,129,0.1); color: var(--green); }
        .pill-pending { background: rgba(245,158,11,0.1); color: var(--amber); }
        .status-open { background: rgba(93,161,161,0.1); color: var(--primary); }
        .status-approved { background: rgba(16,185,129,0.1); color: var(--green); }
        .status-rejected { background: rgba(239,68,68,0.1); color: var(--red); }

        .arrow-wrapper { position: relative; display: inline-block; cursor: help; }
        .arrow { display: block; width: 0; height: 0; }
        .arrow-high { border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid var(--red); }
        .arrow-medium { border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid var(--amber); }
        .arrow-low { border-left: 8px solid transparent; border-right: 8px transparent; border-top: 10px solid var(--green); }
        .tooltip {
            visibility: hidden; position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;
            white-space: nowrap; opacity: 0; transition: opacity 0.2s; z-index: 10;
        }
        .tooltip::after {
            content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid #333;
        }
        .arrow-wrapper:hover .tooltip { visibility: visible; opacity: 1; }

        .icon-btn {
            width: 32px; height: 32px; border-radius: 8px; background: transparent; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary);
            transition: var(--transition);
        }
        
        .icon-btn.small {
            width: 28px;
            height: 28px;
            font-size: 12px;
        }
        
        .icon-btn.danger {
            color: var(--red);
        }
        
        .icon-btn.danger:hover {
            background: rgba(239,68,68,0.1);
        }
        
        .icon-btn:hover { background: rgba(93,161,161,0.1); color: var(--primary); }

        /* RAM Pill Styles */
        .ram-pill { padding: 4px 8px; border-radius: 999px; font-size: 10px; font-weight: 600; }
        .ram-low { background: rgba(16,185,129,0.1); color: var(--green); }
        .ram-medium { background: rgba(245,158,11,0.1); color: var(--amber); }
        .ram-high { background: rgba(239,68,68,0.1); color: var(--red); }

        .manageability-pill { padding: 4px 8px; border-radius: 999px; font-size: 10px; font-weight: 600; }
        .can-control { background: rgba(16,185,129,0.1); color: var(--green); }
        .can-influence { background: rgba(245,158,11,0.1); color: var(--amber); }
        .cannot-influence { background: rgba(239,68,68,0.1); color: var(--red); }

        .threshold-badge {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block;
            margin-left: 6px; vertical-align: middle;
        }
        .threshold-changing { background: var(--red); }
        .threshold-stable { background: var(--green); }

        /* Full Page Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.open {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            box-shadow: none;
            animation: fadeIn 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-header {
            padding: 20px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            flex-shrink: 0;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            cursor: pointer;
            font-size: 24px;
            color: var(--text-secondary);
            line-height: 1;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .modal-close:hover {
            background: rgba(93,161,161,0.1);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 32px;
            flex: 1;
            overflow-y: auto;
            background: var(--bg);
        }
        
        .modal-footer {
            padding: 20px 32px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: var(--card-bg);
            flex-shrink: 0;
        }
        
        .btn-secondary, .btn-success {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-success {
            background: var(--primary);
            color: white;
        }
        
        .btn-success:hover {
            background: var(--primary-hover);
        }
        
        .btn-success.loading {
            position: relative;
            color: transparent;
        }
        
        .btn-success.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: button-spin 0.8s linear infinite;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
            background: white;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(93,161,161,0.1);
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .required::after {
            content: ' *';
            color: var(--red);
        }
        
        /* Form Container */
        .form-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .form-section {
            margin-bottom: 32px;
            padding: 24px;
            background: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Card-like containers for causes/consequences */
        .item-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            transition: var(--transition);
        }
        
        .item-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        
        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #e2e8f0;
        }
        
        .item-card-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .item-card-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Action items styling - UPDATED */
        .action-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            position: relative;
            transition: var(--transition);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        
        .action-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        
        .action-item::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 24px;
            width: 16px;
            height: 1px;
            background: var(--border);
        }
        
        .action-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .action-item-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-item-title::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
        }
        
        .action-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .action-item-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .action-item-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--neutral);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .action-item-label i {
            font-size: 10px;
            opacity: 0.7;
        }
        
        .action-item-input, .action-item-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            transition: var(--transition);
            background: white;
        }
        
        .action-item-input:focus, .action-item-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(93,161,161,0.1);
        }
        
        .action-item-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            padding-right: 30px;
            cursor: pointer;
        }
        
        .action-item-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Action type indicators */
        .action-item.preventive {
            border-left: 3px solid var(--primary);
        }
        
        .action-item.preventive .action-item-title::before {
            background: var(--primary);
        }
        
        .action-item.recovery {
            border-left: 3px solid var(--amber);
        }
        
        .action-item.recovery .action-item-title::before {
            background: var(--amber);
        }
        
        /* Status badges for actions */
        .action-status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .action-status-badge.pending {
            background: rgba(245,158,11,0.1);
            color: var(--amber);
        }
        
        .action-status-badge.in-progress {
            background: rgba(59,130,246,0.1);
            color: var(--blue);
        }
        
        .action-status-badge.completed {
            background: rgba(16,185,129,0.1);
            color: var(--green);
        }
        
        /* RAM Section Styles */
        .ram-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
        }
        
        .ram-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 16px;
        }
        
        .ram-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            transition: var(--transition);
        }
        
        .ram-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        
        .ram-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .ram-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .ram-values {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .ram-values .form-group {
            margin-bottom: 0;
            flex: 1;
        }
        
        .ram-arrow {
            font-size: 14px;
            color: var(--neutral);
            font-weight: 500;
        }
        
        /* Add buttons */
        .add-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: white;
            border: 2px dashed var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: var(--transition);
            margin-top: 8px;
        }
        
        .add-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(93,161,161,0.05);
        }
        
        /* Small buttons */
        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(93,161,161,0.05);
        }
        
        .btn-danger {
            background: transparent;
            border: 1px solid var(--red);
            color: var(--red);
        }
        
        .btn-danger:hover {
            background: rgba(239,68,68,0.1);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
        }
        
        .toast-message {
            font-size: 14px;
            font-weight: 500;
        }
        
        .toast.error { border-left-color: var(--red); }
        .toast.error .toast-icon { color: var(--red); }
        .toast.success { border-left-color: var(--green); }
        .toast.success .toast-icon { color: var(--green); }
        .toast.warning { border-left-color: var(--amber); }
        .toast.warning .toast-icon { color: var(--amber); }

        /* View Mode Back Button */
        .view-back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }
        
        .view-back-btn:hover {
            background: rgba(93,161,161,0.06);
            color: var(--primary);
            border-color: var(--primary);
        }

        /* Asset Selector */
        .asset-selector-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            background: white;
        }

        /* Responsive */
        @media (max-width: 1024px) { 
            table { min-width: 2000px; } 
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .form-row .form-group {
                margin-bottom: 16px;
            }
            .ram-grid {
                grid-template-columns: 1fr;
            }
            .action-item-details {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .page-content { padding: 16px; }
            .top-nav { 
                padding: 0 16px; 
                flex-direction: column;
                height: auto;
                padding: 12px 16px;
                gap: 12px;
            }
            .tabs-group {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 4px;
            }
            .actions-group { 
                width: 100%;
                flex-wrap: wrap;
                gap: 8px; 
                justify-content: flex-end; 
            }
            .search-box input { 
                width: 100%;
                min-width: 200px;
            }
            .table-view { 
                display: none; 
                padding: 16px; 
            }
            .card-view { 
                display: block; 
            }
            .modal-body {
                padding: 20px;
            }
            .modal-header,
            .modal-footer {
                padding: 16px 20px;
            }
            .form-section {
                padding: 16px;
            }
            .btn-secondary,
            .btn-success {
                padding: 10px 16px;
                min-width: 100px;
                font-size: 13px;
            }
            .view-back-btn {
                top: 10px;
                left: 10px;
                padding: 6px 12px;
                font-size: 12px;
            }
            .action-item-details {
                grid-template-columns: 1fr;
            }
            .action-item::before {
                display: none;
            }
            .ram-values {
                flex-direction: column;
                gap: 8px;
            }
            .ram-arrow {
                transform: rotate(90deg);
            }
            .action-item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .action-item-actions {
                align-self: flex-end;
            }
        }
        
        @media (max-height: 800px) {
            .modal-body {
                padding: 24px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            .form-section {
                padding: 20px;
            }
        }
        
        /* Focus states for accessibility */
        *:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        *:focus:not(:focus-visible) {
            outline: none;
        }
        
        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
    </style>
</head>
<body>

    <nav class="top-nav">
        <div class="tabs-group">
            <div class="nav-tab active" data-content="risks-content">
                <div class="favicon">R</div>
                <span>My Risks</span>
            </div>
            <div class="nav-tab" id="riskVisualTab" onclick="openRiskVisual()">
                <div class="favicon">V</div>
                <span>Risk Visual</span>
            </div>
        </div>
        <div class="actions-group">
            <div class="search-box">
                <input type="text" placeholder="Search my risks..." id="searchInput" onkeyup="searchRisks()">
            </div>
            <button class="btn-icon" onclick="refreshRisks()" title="Refresh">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn-primary" onclick="openCreateRiskModal()">
                <i class="fas fa-plus"></i> New Risk
            </button>
        </div>
    </nav>

    <main class="main">
        <div class="content-wrapper">
            <!-- Risks Content -->
            <div id="risks-content" class="page-content" style="display:block;">
                <!-- Desktop Table -->
                <div class="table-view">
                    <div class="table-container">
                        <table id="risksTable">
                            <thead>
                                <tr>
                                    <th>Risk ID</th>
                                    <th>Type</th>
                                    <th>Title</th>
                                    <th>Asset</th>
                                    <th>Status</th>
                                    <th>Occurrence Level</th>
                                    <th>Risk Owner</th>
                                    <th>Sub Project</th>
                                    <th>Exposure Start</th>
                                    <th>Exposure End</th>
                                    <th>Next Review</th>
                                    <th>Project RAM</th>
                                    <th>Manageability</th>
                                    <th>Created</th>
                                    <th>Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="risksTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Mobile Cards -->
                <div class="card-view" id="mobileRisks"></div>
            </div>

            <!-- View content will be loaded dynamically when viewing a risk -->
            <div id="view-content" class="page-content" style="display:none;">
                <!-- This will be populated when viewing a risk -->
            </div>
        </div>
    </main>

    <!-- Create Risk Modal -->
    <div class="modal-overlay" id="createRiskModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create New Risk</div>
                <div class="modal-close" onclick="closeCreateRiskModal()">×</div>
            </div>
            <div class="modal-body">
                <div class="form-container">
                    <form id="createRiskForm">
                        <!-- SECTION 1: Context & Ownership -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-project-diagram"></i>
                                Context & Ownership
                            </h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="assetId_create" class="required">Asset</label>
                                    <select id="assetId_create" class="asset-selector-input" required>
                                        <option value="">Select asset</option>
                                        <!-- Assets loaded dynamically -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="subProject_create" class="required">Sub-Project / Department</label>
                                    <input type="text" id="subProject_create" placeholder="e.g., Phase 2 Construction" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="riskType_create" class="required">Risk Type</label>
                                    <select id="riskType_create" required>
                                        <option value="">Select type</option>
                                        <option value="Downside">Downside (Threat)</option>
                                        <option value="Upside">Upside (Opportunity)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="riskOwner_create" class="required">Risk Owner</label>
                                    <input type="text" id="riskOwner_create" placeholder="Name of responsible person" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="functionalAreaTECOP_create" class="required">Functional Area (TECOP)</label>
                                    <select id="functionalAreaTECOP_create" required>
                                        <option value="">Select area</option>
                                        <option value="Technical">Technical</option>
                                        <option value="Environmental">Environmental</option>
                                        <option value="Commercial">Commercial</option>
                                        <option value="Operational">Operational</option>
                                        <option value="Political">Political</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 2: Risk Definition -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Risk Definition
                            </h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="riskTitle_create" class="required">Risk Title</label>
                                    <input type="text" id="riskTitle_create" placeholder="Clear, concise risk statement" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="description_create" class="required">Risk Description</label>
                                    <textarea id="description_create" placeholder="Describe the risk scenario, background, and context..." required rows="3"></textarea>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="event_create" class="required">Risk Event</label>
                                    <textarea id="event_create" placeholder="Single statement describing the central risk event (e.g., 'Equipment failure during operation')" required rows="2"></textarea>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="occurenceLevel_create" class="required">Occurrence Level</label>
                                    <select id="occurenceLevel_create" required>
                                        <option value="">Select likelihood</option>
                                        <option value="Low">Low (Unlikely)</option>
                                        <option value="Medium">Medium (Possible)</option>
                                        <option value="High">High (Likely)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="exposureStart_create">Exposure Start Date</label>
                                    <input type="date" id="exposureStart_create">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="exposureEnd_create">Exposure End Date</label>
                                    <input type="date" id="exposureEnd_create">
                                </div>
                                <div class="form-group">
                                    <label for="nextReviewDate_create">Next Review Date</label>
                                    <input type="date" id="nextReviewDate_create">
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 3: Causes & Actions -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-shield-alt"></i>
                                Causes & Preventive Actions
                            </h3>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">
                                Define root causes and preventive actions to stop the risk event from occurring.
                            </p>
                            
                            <div id="causes-container">
                                <!-- Dynamic causes will be added here -->
                                <div class="item-card" data-cause-index="0">
                                    <div class="item-card-header">
                                        <div class="item-card-title">Cause #1</div>
                                        <div class="item-card-actions">
                                            <button type="button" class="btn-sm btn-outline" onclick="addActionToCause(0)">
                                                <i class="fas fa-plus"></i> Add Action
                                            </button>
                                            <button type="button" class="btn-sm btn-danger" onclick="removeCause(0)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Cause Description</label>
                                        <textarea class="cause-description" placeholder="Describe the root cause (e.g., 'Lack of preventive maintenance')" required rows="2"></textarea>
                                    </div>
                                    
                                    <div class="actions-container">
                                        <!-- Actions will be added here with new styling -->
                                        <div class="action-item preventive" data-action-index="0">
                                            <div class="action-item-header">
                                                <div class="action-item-title">
                                                    Preventive Action #1
                                                    <span class="action-status-badge pending">Pending</span>
                                                </div>
                                                <div class="action-item-actions">
                                                    <button type="button" class="icon-btn small" title="Edit action">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="icon-btn small danger" title="Remove action" onclick="removeAction(0, 0)">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="action-item-details">
                                                <div class="action-item-field">
                                                    <label class="action-item-label">
                                                        <i class="fas fa-heading"></i>
                                                        Action Title
                                                    </label>
                                                    <input type="text" class="action-item-input action-title" 
                                                           placeholder="e.g., Implement monthly maintenance checks" required>
                                                </div>
                                                <div class="action-item-field">
                                                    <label class="action-item-label">
                                                        <i class="fas fa-user"></i>
                                                        Owner
                                                    </label>
                                                    <input type="text" class="action-item-input action-owner" 
                                                           placeholder="Responsible person">
                                                </div>
                                                <div class="action-item-field">
                                                    <label class="action-item-label">
                                                        <i class="fas fa-calendar"></i>
                                                        Due Date
                                                    </label>
                                                    <input type="date" class="action-item-input action-due-date">
                                                </div>
                                                <div class="action-item-field">
                                                    <label class="action-item-label">
                                                        <i class="fas fa-tasks"></i>
                                                        Status
                                                    </label>
                                                    <select class="action-item-select action-status">
                                                        <option value="pending" selected>Pending</option>
                                                        <option value="in-progress">In Progress</option>
                                                        <option value="completed">Completed</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" class="add-btn" onclick="addCause()">
                                <i class="fas fa-plus-circle"></i> Add Another Cause
                            </button>
                        </div>

                        <!-- SECTION 4: Consequences & Controls -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-ambulance"></i>
                                Consequences & Recovery Actions
                            </h3>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">
                                Define potential impacts and recovery actions to mitigate consequences if the risk occurs.
                            </p>
                            
                            <div id="consequences-container">
                                <!-- Dynamic consequences will be added here -->
                                <div class="item-card" data-consequence-index="0">
                                    <div class="item-card-header">
                                        <div class="item-card-title">Consequence #1</div>
                                        <div class="item-card-actions">
                                            <button type="button" class="btn-sm btn-outline" onclick="addControlToConsequence(0)">
                                                <i class="fas fa-plus"></i> Add Control
                                            </button>
                                            <button type="button" class="btn-sm btn-danger" onclick="removeConsequence(0)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="required">Consequence Description</label>
                                        <textarea class="consequence-description" placeholder="Describe the impact (e.g., 'Production downtime of 48 hours')" required rows="2"></textarea>
                                    </div>
                                    
                                    <div class="controls-container">
                                        <!-- Controls will be added here with new styling -->
                                        <div class="action-item recovery" data-control-index="0">
                                            <div class="action-item-header">
                                                <div class="action-item-title">
                                                    Recovery Control #1
                                                    <span class="action-status-badge pending">Pending</span>
                                                </div>
                                                <div class="action-item-actions">
                                                    <button type="button" class="icon-btn small" title="Edit control">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="icon-btn small danger" title="Remove control" onclick="removeControl(0, 0)">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="action-item-details">
                                                <div class="action-item-field">
                                                    <label class="action-item-label">
                                                        <i class="fas fa-heading"></i>
                                                        Control Title
                                                    </label>
                                                    <input type="text" class="action-item-input control-title" 
                                                           placeholder="e.g., Activate backup power system" required>
                                                </div>
                                                <div class="action-item-field">
                                                    <label class="action-item-label">
                                                        <i class="fas fa-user"></i>
                                                        Owner
                                                    </label>
                                                    <input type="text" class="action-item-input control-owner" 
                                                           placeholder="Responsible person">
                                                </div>
                                                <div class="action-item-field">
                                                    <label class="action-item-label">
                                                        <i class="fas fa-calendar"></i>
                                                        Due Date
                                                    </label>
                                                    <input type="date" class="action-item-input control-due-date">
                                                </div>
                                                <div class="action-item-field">
                                                    <label class="action-item-label">
                                                        <i class="fas fa-tasks"></i>
                                                        Status
                                                    </label>
                                                    <select class="action-item-select control-status">
                                                        <option value="pending" selected>Pending</option>
                                                        <option value="in-progress">In Progress</option>
                                                        <option value="completed">Completed</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" class="add-btn" onclick="addConsequence()">
                                <i class="fas fa-plus-circle"></i> Add Another Consequence
                            </button>
                        </div>

                        <!-- SECTION 5: Risk Assessment -->
                        <div class="form-section ram-section">
                            <h3 class="section-title">
                                <i class="fas fa-chart-line"></i>
                                Risk Assessment
                            </h3>
                            
                            <div class="ram-grid">
                                <div class="ram-card">
                                    <div class="ram-card-header">
                                        <span class="ram-card-title">Project RAM</span>
                                    </div>
                                    <div class="ram-values">
                                        <div class="form-group">
                                            <label>Current</label>
                                            <select id="projectRamCurrent_create">
                                                <option value="">Select level</option>
                                                <option value="Low">Low</option>
                                                <option value="Medium">Medium</option>
                                                <option value="High">High</option>
                                            </select>
                                        </div>
                                        <span class="ram-arrow">→</span>
                                        <div class="form-group">
                                            <label>Target</label>
                                            <select id="projectRamTarget_create">
                                                <option value="">Select level</option>
                                                <option value="Low">Low</option>
                                                <option value="Medium">Medium</option>
                                                <option value="High">High</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="ram-card">
                                    <div class="ram-card-header">
                                        <span class="ram-card-title">Risk Visual RAM</span>
                                    </div>
                                    <div class="ram-values">
                                        <div class="form-group">
                                            <label>Current</label>
                                            <select id="riskVisualRamCurrent_create">
                                                <option value="">Select level</option>
                                                <option value="Low">Low</option>
                                                <option value="Medium">Medium</option>
                                                <option value="High">High</option>
                                            </select>
                                        </div>
                                        <span class="ram-arrow">→</span>
                                        <div class="form-group">
                                            <label>Target</label>
                                            <select id="riskVisualRamTarget_create">
                                                <option value="">Select level</option>
                                                <option value="Low">Low</option>
                                                <option value="Medium">Medium</option>
                                                <option value="High">High</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="ram-card">
                                    <div class="ram-card-header">
                                        <span class="ram-card-title">HSSE RAM</span>
                                    </div>
                                    <div class="ram-values">
                                        <div class="form-group">
                                            <label>Current</label>
                                            <select id="hsseRamCurrent_create">
                                                <option value="">Select level</option>
                                                <option value="Low">Low</option>
                                                <option value="Medium">Medium</option>
                                                <option value="High">High</option>
                                            </select>
                                        </div>
                                        <span class="ram-arrow">→</span>
                                        <div class="form-group">
                                            <label>Target</label>
                                            <select id="hsseRamTarget_create">
                                                <option value="">Select level</option>
                                                <option value="Low">Low</option>
                                                <option value="Medium">Medium</option>
                                                <option value="High">High</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row" style="margin-top: 24px;">
                                <div class="form-group">
                                    <label for="manageability_create">Manageability</label>
                                    <select id="manageability_create">
                                        <option value="">Select level</option>
                                        <option value="Can Control">Can Control</option>
                                        <option value="Can Influence">Can Influence</option>
                                        <option value="Cannot Influence">Cannot Influence</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="thresholdChanging_create">Threshold Changing</label>
                                    <select id="thresholdChanging_create">
                                        <option value="false">No (Stable)</option>
                                        <option value="true">Yes (Changing)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCreateRiskModal()">Cancel</button>
                <button class="btn-success" onclick="createNewRisk()">
                    <i class="fas fa-paper-plane"></i> Submit for Approval
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

<script>
// Global variables
let allAssets = [];
let risks = [];
let causeCount = 1;
let consequenceCount = 1;

// Utility functions
function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function capitalize(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}

function getRamClass(ramLevel) {
    if (!ramLevel) return '';
    ramLevel = ramLevel.toLowerCase();
    if (ramLevel === 'low') return 'ram-pill ram-low';
    if (ramLevel === 'medium') return 'ram-pill ram-medium';
    if (ramLevel === 'high') return 'ram-pill ram-high';
    return 'ram-pill';
}

function getManageabilityClass(manageability) {
    if (!manageability) return '';
    if (manageability === 'Can Control') return 'manageability-pill can-control';
    if (manageability === 'Can Influence') return 'manageability-pill can-influence';
    if (manageability === 'Cannot Influence') return 'manageability-pill cannot-influence';
    return 'manageability-pill';
}

function getStatusClass(status) {
    if (!status) return '';
    status = status.toLowerCase();
    if (status === 'pending') return 'pill-pending';
    if (status === 'approved') return 'status-approved';
    if (status === 'rejected') return 'status-rejected';
    if (status === 'open') return 'status-open';
    return '';
}

// Update status badge when status changes
function updateActionStatus(actionElement) {
    const statusSelect = actionElement.querySelector('.action-status, .control-status');
    const statusBadge = actionElement.querySelector('.action-status-badge');
    if (statusSelect && statusBadge) {
        const status = statusSelect.value;
        statusBadge.className = `action-status-badge ${status}`;
        statusBadge.textContent = status.replace('-', ' ');
    }
}

// Load assigned assets for dropdown
async function loadAssignedAssets() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/analyst/assets', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const assets = await response.json();
            allAssets = Array.isArray(assets) ? assets : [];
            updateAssetDropdown();
        } else {
            // Fallback to all assets
            await loadAllAssets();
        }
    } catch (error) {
        console.error('Error loading assigned assets:', error);
        await loadAllAssets();
    }
}

async function loadAllAssets() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/assets', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            allAssets = Array.isArray(data) ? data : [];
            updateAssetDropdown();
        }
    } catch (error) {
        console.error('Error loading all assets:', error);
        allAssets = [];
    }
}

function updateAssetDropdown() {
    const assetSelect = document.getElementById('assetId_create');
    if (!assetSelect) return;
    
    // Clear existing options except first one
    assetSelect.innerHTML = '<option value="">Select asset</option>';
    
    // Add asset options
    allAssets.forEach(asset => {
        const option = document.createElement('option');
        option.value = asset._id || asset.id;
        option.textContent = asset.name || `Asset ${asset._id}`;
        assetSelect.appendChild(option);
    });
}

// Load risks
async function loadRisks() {
    const tbody = document.getElementById('risksTableBody');
    const mobileContainer = document.getElementById('mobileRisks');
    
    if (!tbody || !mobileContainer) return;
    
    showSkeleton();
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/analyst/risks', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        risks = data.risks || [];
        renderRisks(risks);
        
    } catch (error) {
        console.error('Error loading risks:', error);
        showToast('Failed to load risks', 'error');
        showEmptyState();
    }
}

function showSkeleton() {
    const tbody = document.getElementById('risksTableBody');
    const mobileContainer = document.getElementById('mobileRisks');
    
    if (!tbody || !mobileContainer) return;
    
    tbody.innerHTML = '';
    mobileContainer.innerHTML = '';
    
    // Desktop skeleton
    for (let i = 0; i < 5; i++) {
        const row = document.createElement('tr');
        row.className = 'skeleton-row';
        row.innerHTML = `
            <td><div class="skeleton skeleton-cell short"></div></td>
            <td><div class="skeleton skeleton-pill"></div></td>
            <td><div class="skeleton skeleton-cell long"></div></td>
            <td><div class="skeleton skeleton-cell medium"></div></td>
            <td><div class="skeleton skeleton-pill"></div></td>
            <td><div style="width:40px;height:24px;border-radius:8px;" class="skeleton"></div></td>
            <td><div class="skeleton skeleton-cell medium"></div></td>
            <td><div class="skeleton skeleton-cell medium"></div></td>
            <td><div class="skeleton skeleton-cell short"></div></td>
            <td><div class="skeleton skeleton-cell short"></div></td>
            <td><div class="skeleton skeleton-cell short"></div></td>
            <td><div class="skeleton skeleton-pill"></div></td>
            <td><div class="skeleton skeleton-pill"></div></td>
            <td><div class="skeleton skeleton-cell short"></div></td>
            <td><div class="skeleton skeleton-cell short"></div></td>
            <td><div style="width:64px;height:32px;border-radius:8px;" class="skeleton"></div></td>
        `;
        tbody.appendChild(row);
    }
    
    // Mobile skeleton
    for (let i = 0; i < 3; i++) {
        const card = document.createElement('div');
        card.className = 'risk-card skeleton';
        card.innerHTML = `
            <div class="risk-card-header">
                <div class="skeleton" style="height:24px;width:70%;"></div>
                <div class="skeleton" style="width:32px;height:32px;border-radius:8px;"></div>
            </div>
            <div class="risk-card-grid">
                <div class="skeleton" style="height:16px;width:60%;"></div><div class="skeleton" style="height:20px;width:85%;"></div>
                <div class="skeleton" style="height:16px;width:60%;"></div><div class="skeleton" style="height:20px;width:85%;"></div>
                <div class="skeleton" style="height:16px;width:60%;"></div><div class="skeleton" style="height:20px;width:85%;"></div>
                <div class="skeleton" style="height:16px;width:60%;"></div><div class="skeleton" style="height:20px;width:85%;"></div>
            </div>
        `;
        mobileContainer.appendChild(card);
    }
}

function showEmptyState() {
    const tbody = document.getElementById('risksTableBody');
    const mobileContainer = document.getElementById('mobileRisks');
    
    if (!tbody || !mobileContainer) return;
    
    const emptyState = `
        <tr>
            <td colspan="16" style="text-align:center;padding:80px 20px;">
                <i class="fas fa-exclamation-triangle" style="font-size:48px;opacity:0.3;margin-bottom:16px;"></i>
                <div style="font-size:16px;font-weight:500;color:var(--text-secondary);margin-bottom:8px;">
                    No risks found
                </div>
                <div style="font-size:13px;color:var(--neutral);margin-bottom:24px;">
                    Create your first risk to get started
                </div>
                <button class="btn-primary" onclick="openCreateRiskModal()">
                    <i class="fas fa-plus"></i> Create First Risk
                </button>
            </td>
        </tr>`;
    
    tbody.innerHTML = emptyState;
    mobileContainer.innerHTML = emptyState;
}

function renderRisks(risks) {
    const tbody = document.getElementById('risksTableBody');
    const mobileContainer = document.getElementById('mobileRisks');
    
    if (!tbody || !mobileContainer) return;
    
    if (!risks || risks.length === 0) {
        showEmptyState();
        return;
    }
    
    tbody.innerHTML = '';
    mobileContainer.innerHTML = '';
    
    // Desktop table
    risks.forEach(risk => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${escapeHtml(risk.riskId || '—')}</td>
            <td><span class="pill ${risk.type?.toLowerCase() === 'upside' ? 'pill-upside' : 'pill-downside'}">
                ${escapeHtml(risk.type || 'Downside')}
            </span></td>
            <td>${escapeHtml(risk.title || '—')}</td>
            <td>${escapeHtml(risk.assetName || '—')}</td>
            <td><span class="pill ${getStatusClass(risk.status)}">${escapeHtml(risk.status || 'Open')}</span></td>
            <td><div class="arrow-wrapper">
                <div class="arrow arrow-${risk.occurenceLevel?.toLowerCase() || 'medium'}"></div>
                <div class="tooltip">${capitalize(risk.occurenceLevel || 'Medium')}</div>
            </div></td>
            <td>${escapeHtml(risk.riskOwnerName || '—')}</td>
            <td>${escapeHtml(risk.subProject || '—')}</td>
            <td>${risk.exposureStartDate ? new Date(risk.exposureStartDate).toISOString().split('T')[0] : '—'}</td>
            <td>${risk.exposureEndDate ? new Date(risk.exposureEndDate).toISOString().split('T')[0] : '—'}</td>
            <td>${risk.nextReviewDate ? new Date(risk.nextReviewDate).toISOString().split('T')[0] : '—'}</td>
            <td><span class="${getRamClass(risk.projectRamCurrent)}">${escapeHtml(risk.projectRamCurrent || '—')}</span> → 
                <span class="${getRamClass(risk.projectRamTarget)}">${escapeHtml(risk.projectRamTarget || '—')}</span></td>
            <td><span class="${getManageabilityClass(risk.manageability)}">${escapeHtml(risk.manageability || '—')}</span></td>
            <td>${risk.createdAt ? new Date(risk.createdAt).toLocaleDateString() : '—'}</td>
            <td>${risk.updatedAt ? new Date(risk.updatedAt).toLocaleDateString() : '—'}</td>
            <td>
                <button class="icon-btn" onclick="viewRiskDetail('${risk._id}')" title="View">
                    <i class="fas fa-eye"></i>
                </button>
                ${risk.status === 'pending' ? '' : `
                <button class="icon-btn" onclick="editRisk('${risk._id}')" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                `}
            </td>
        `;
        tbody.appendChild(row);
        
        // Mobile card
        const card = document.createElement('div');
        card.className = 'risk-card';
        card.innerHTML = `
            <div class="risk-card-header">
                <div class="risk-card-title" onclick="viewRiskDetail('${risk._id}')">
                    ${escapeHtml(risk.riskId || '—')}: ${escapeHtml(risk.title || '—')}
                </div>
                <button class="icon-btn" onclick="viewRiskDetail('${risk._id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div class="risk-card-grid">
                <div class="risk-card-label">Type</div>
                <div><span class="pill ${risk.type?.toLowerCase() === 'upside' ? 'pill-upside' : 'pill-downside'}">
                    ${escapeHtml(risk.type || 'Downside')}
                </span></div>
                
                <div class="risk-card-label">Status</div>
                <div><span class="pill ${getStatusClass(risk.status)}">${escapeHtml(risk.status || 'Open')}</span></div>
                
                <div class="risk-card-label">Asset</div>
                <div>${escapeHtml(risk.assetName || '—')}</div>
                
                <div class="risk-card-label">Owner</div>
                <div>${escapeHtml(risk.riskOwnerName || '—')}</div>
                
                <div class="risk-card-label">Occurrence</div>
                <div><div class="arrow-wrapper">
                    <div class="arrow arrow-${risk.occurenceLevel?.toLowerCase() || 'medium'}"></div>
                    <div class="tooltip">${capitalize(risk.occurenceLevel || 'Medium')}</div>
                </div></div>
                
                <div class="risk-card-label">Project RAM</div>
                <div><span class="${getRamClass(risk.projectRamCurrent)}">${escapeHtml(risk.projectRamCurrent || '—')}</span> → 
                    <span class="${getRamClass(risk.projectRamTarget)}">${escapeHtml(risk.projectRamTarget || '—')}</span></div>
                
                <div class="risk-card-label">Created</div>
                <div>${risk.createdAt ? new Date(risk.createdAt).toLocaleDateString() : '—'}</div>
            </div>
            <div style="margin-top: 16px; display: flex; gap: 8px;">
                <button class="btn-secondary" onclick="viewRiskDetail('${risk._id}')" style="flex: 1; padding: 8px;">
                    View Details
                </button>
                ${risk.status === 'pending' ? '' : `
                <button class="btn-primary" onclick="editRisk('${risk._id}')" style="flex: 1; padding: 8px;">
                    <i class="fas fa-edit"></i> Edit
                </button>
                `}
            </div>
        `;
        mobileContainer.appendChild(card);
    });
}

// Search functionality
let searchTimeout;
function searchRisks() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        if (searchTerm === '') {
            renderRisks(risks);
            return;
        }
        
        const filteredRisks = risks.filter(risk => {
            return (
                (risk.title && risk.title.toLowerCase().includes(searchTerm)) ||
                (risk.riskId && risk.riskId.toLowerCase().includes(searchTerm)) ||
                (risk.description && risk.description.toLowerCase().includes(searchTerm)) ||
                (risk.riskOwnerName && risk.riskOwnerName.toLowerCase().includes(searchTerm)) ||
                (risk.subProject && risk.subProject.toLowerCase().includes(searchTerm))
            );
        });
        
        renderRisks(filteredRisks);
    }, 300);
}

// Dynamic Form Functions
function addCause() {
    const container = document.getElementById('causes-container');
    const causeIndex = causeCount++;
    
    const causeCard = document.createElement('div');
    causeCard.className = 'item-card';
    causeCard.dataset.causeIndex = causeIndex;
    causeCard.innerHTML = `
        <div class="item-card-header">
            <div class="item-card-title">Cause #${causeIndex + 1}</div>
            <div class="item-card-actions">
                <button type="button" class="btn-sm btn-outline" onclick="addActionToCause(${causeIndex})">
                    <i class="fas fa-plus"></i> Add Action
                </button>
                <button type="button" class="btn-sm btn-danger" onclick="removeCause(${causeIndex})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="form-group">
            <label class="required">Cause Description</label>
            <textarea class="cause-description" placeholder="Describe the root cause" required rows="2"></textarea>
        </div>
        <div class="actions-container">
            <!-- Actions will be added here -->
        </div>
    `;
    
    container.appendChild(causeCard);
}

function removeCause(index) {
    const container = document.getElementById('causes-container');
    const causeCard = container.querySelector(`[data-cause-index="${index}"]`);
    if (causeCard && container.children.length > 1) {
        causeCard.remove();
        // Re-index remaining causes
        const causes = container.querySelectorAll('.item-card');
        causes.forEach((cause, i) => {
            cause.dataset.causeIndex = i;
            const title = cause.querySelector('.item-card-title');
            if (title) title.textContent = `Cause #${i + 1}`;
        });
        causeCount = causes.length;
    }
}

function addActionToCause(causeIndex) {
    const causeCard = document.querySelector(`[data-cause-index="${causeIndex}"]`);
    if (!causeCard) return;
    
    const actionsContainer = causeCard.querySelector('.actions-container');
    const actionIndex = actionsContainer.children.length;
    
    const actionItem = document.createElement('div');
    actionItem.className = 'action-item preventive';
    actionItem.dataset.actionIndex = actionIndex;
    actionItem.innerHTML = `
        <div class="action-item-header">
            <div class="action-item-title">
                Preventive Action #${actionIndex + 1}
                <span class="action-status-badge pending">Pending</span>
            </div>
            <div class="action-item-actions">
                <button type="button" class="icon-btn small" title="Edit action">
                    <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="icon-btn small danger" title="Remove action" onclick="removeAction(${causeIndex}, ${actionIndex})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="action-item-details">
            <div class="action-item-field">
                <label class="action-item-label">
                    <i class="fas fa-heading"></i>
                    Action Title
                </label>
                <input type="text" class="action-item-input action-title" 
                       placeholder="e.g., Implement monthly maintenance checks" required
                       onchange="updateActionStatus(this.closest('.action-item'))">
            </div>
            <div class="action-item-field">
                <label class="action-item-label">
                    <i class="fas fa-user"></i>
                    Owner
                </label>
                <input type="text" class="action-item-input action-owner" 
                       placeholder="Responsible person">
            </div>
            <div class="action-item-field">
                <label class="action-item-label">
                    <i class="fas fa-calendar"></i>
                    Due Date
                </label>
                <input type="date" class="action-item-input action-due-date">
            </div>
            <div class="action-item-field">
                <label class="action-item-label">
                    <i class="fas fa-tasks"></i>
                    Status
                </label>
                <select class="action-item-select action-status" onchange="updateActionStatus(this.closest('.action-item'))">
                    <option value="pending" selected>Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
        </div>
    `;
    
    actionsContainer.appendChild(actionItem);
}

function removeAction(causeIndex, actionIndex) {
    const causeCard = document.querySelector(`[data-cause-index="${causeIndex}"]`);
    if (!causeCard) return;
    
    const actionsContainer = causeCard.querySelector('.actions-container');
    const actionItem = actionsContainer.querySelector(`[data-action-index="${actionIndex}"]`);
    if (actionItem) {
        actionItem.remove();
        // Re-index remaining actions
        const actions = actionsContainer.querySelectorAll('.action-item');
        actions.forEach((action, i) => {
            action.dataset.actionIndex = i;
            const title = action.querySelector('.action-item-title');
            if (title) {
                const titleText = title.textContent.split('#')[0];
                title.innerHTML = `${titleText.trim()} #${i + 1}${title.querySelector('.action-status-badge').outerHTML}`;
            }
        });
    }
}

function addConsequence() {
    const container = document.getElementById('consequences-container');
    const consequenceIndex = consequenceCount++;
    
    const consequenceCard = document.createElement('div');
    consequenceCard.className = 'item-card';
    consequenceCard.dataset.consequenceIndex = consequenceIndex;
    consequenceCard.innerHTML = `
        <div class="item-card-header">
            <div class="item-card-title">Consequence #${consequenceIndex + 1}</div>
            <div class="item-card-actions">
                <button type="button" class="btn-sm btn-outline" onclick="addControlToConsequence(${consequenceIndex})">
                    <i class="fas fa-plus"></i> Add Control
                </button>
                <button type="button" class="btn-sm btn-danger" onclick="removeConsequence(${consequenceIndex})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="form-group">
            <label class="required">Consequence Description</label>
            <textarea class="consequence-description" placeholder="Describe the impact" required rows="2"></textarea>
        </div>
        <div class="controls-container">
            <!-- Controls will be added here -->
        </div>
    `;
    
    container.appendChild(consequenceCard);
}

function removeConsequence(index) {
    const container = document.getElementById('consequences-container');
    const consequenceCard = container.querySelector(`[data-consequence-index="${index}"]`);
    if (consequenceCard && container.children.length > 1) {
        consequenceCard.remove();
        // Re-index remaining consequences
        const consequences = container.querySelectorAll('.item-card');
        consequences.forEach((consequence, i) => {
            consequence.dataset.consequenceIndex = i;
            const title = consequence.querySelector('.item-card-title');
            if (title) title.textContent = `Consequence #${i + 1}`;
        });
        consequenceCount = consequences.length;
    }
}

function addControlToConsequence(consequenceIndex) {
    const consequenceCard = document.querySelector(`[data-consequence-index="${consequenceIndex}"]`);
    if (!consequenceCard) return;
    
    const controlsContainer = consequenceCard.querySelector('.controls-container');
    const controlIndex = controlsContainer.children.length;
    
    const controlItem = document.createElement('div');
    controlItem.className = 'action-item recovery';
    controlItem.dataset.controlIndex = controlIndex;
    controlItem.innerHTML = `
        <div class="action-item-header">
            <div class="action-item-title">
                Recovery Control #${controlIndex + 1}
                <span class="action-status-badge pending">Pending</span>
            </div>
            <div class="action-item-actions">
                <button type="button" class="icon-btn small" title="Edit control">
                    <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="icon-btn small danger" title="Remove control" onclick="removeControl(${consequenceIndex}, ${controlIndex})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="action-item-details">
            <div class="action-item-field">
                <label class="action-item-label">
                    <i class="fas fa-heading"></i>
                    Control Title
                </label>
                <input type="text" class="action-item-input control-title" 
                       placeholder="e.g., Activate backup power system" required
                       onchange="updateActionStatus(this.closest('.action-item'))">
            </div>
            <div class="action-item-field">
                <label class="action-item-label">
                    <i class="fas fa-user"></i>
                    Owner
                </label>
                <input type="text" class="action-item-input control-owner" 
                       placeholder="Responsible person">
            </div>
            <div class="action-item-field">
                <label class="action-item-label">
                    <i class="fas fa-calendar"></i>
                    Due Date
                </label>
                <input type="date" class="action-item-input control-due-date">
            </div>
            <div class="action-item-field">
                <label class="action-item-label">
                    <i class="fas fa-tasks"></i>
                    Status
                </label>
                <select class="action-item-select control-status" onchange="updateActionStatus(this.closest('.action-item'))">
                    <option value="pending" selected>Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
        </div>
    `;
    
    controlsContainer.appendChild(controlItem);
}

function removeControl(consequenceIndex, controlIndex) {
    const consequenceCard = document.querySelector(`[data-consequence-index="${consequenceIndex}"]`);
    if (!consequenceCard) return;
    
    const controlsContainer = consequenceCard.querySelector('.controls-container');
    const controlItem = controlsContainer.querySelector(`[data-control-index="${controlIndex}"]`);
    if (controlItem) {
        controlItem.remove();
        // Re-index remaining controls
        const controls = controlsContainer.querySelectorAll('.action-item');
        controls.forEach((control, i) => {
            control.dataset.controlIndex = i;
            const title = control.querySelector('.action-item-title');
            if (title) {
                const titleText = title.textContent.split('#')[0];
                title.innerHTML = `${titleText.trim()} #${i + 1}${title.querySelector('.action-status-badge').outerHTML}`;
            }
        });
    }
}

// Collect causes data
function collectCauses() {
    const causes = [];
    const causeCards = document.querySelectorAll('#causes-container .item-card');
    
    causeCards.forEach((card, index) => {
        const description = card.querySelector('.cause-description').value.trim();
        if (!description) return;
        
        const actions = [];
        const actionItems = card.querySelectorAll('.actions-container .action-item');
        
        actionItems.forEach((actionItem, actionIndex) => {
            const title = actionItem.querySelector('.action-title').value.trim();
            if (!title) return;
            
            actions.push({
                title: title,
                owner: actionItem.querySelector('.action-owner').value.trim(),
                dueDate: actionItem.querySelector('.action-due-date').value || null,
                status: actionItem.querySelector('.action-status').value,
                type: 'preventive',
                order: actionIndex + 1
            });
        });
        
        causes.push({
            description: description,
            actions: actions,
            order: index + 1
        });
    });
    
    return causes;
}

// Collect consequences data
function collectConsequences() {
    const consequences = [];
    const consequenceCards = document.querySelectorAll('#consequences-container .item-card');
    
    consequenceCards.forEach((card, index) => {
        const description = card.querySelector('.consequence-description').value.trim();
        if (!description) return;
        
        const controls = [];
        const controlItems = card.querySelectorAll('.controls-container .action-item');
        
        controlItems.forEach((controlItem, controlIndex) => {
            const title = controlItem.querySelector('.control-title').value.trim();
            if (!title) return;
            
            controls.push({
                title: title,
                owner: controlItem.querySelector('.control-owner').value.trim(),
                dueDate: controlItem.querySelector('.control-due-date').value || null,
                status: controlItem.querySelector('.control-status').value,
                type: 'recovery',
                order: controlIndex + 1
            });
        });
        
        consequences.push({
            description: description,
            actions: controls,
            order: index + 1
        });
    });
    
    return consequences;
}

// Modal functions
function openCreateRiskModal() {
    document.getElementById('createRiskModal').classList.add('open');
    document.body.style.overflow = 'hidden';
    
    // Reset form
    document.getElementById('createRiskForm').reset();
    
    // Reset dynamic sections
    document.getElementById('causes-container').innerHTML = `
        <div class="item-card" data-cause-index="0">
            <div class="item-card-header">
                <div class="item-card-title">Cause #1</div>
                <div class="item-card-actions">
                    <button type="button" class="btn-sm btn-outline" onclick="addActionToCause(0)">
                        <i class="fas fa-plus"></i> Add Action
                    </button>
                    <button type="button" class="btn-sm btn-danger" onclick="removeCause(0)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label class="required">Cause Description</label>
                <textarea class="cause-description" placeholder="Describe the root cause" required rows="2"></textarea>
            </div>
            <div class="actions-container">
                <!-- Actions will be added here -->
            </div>
        </div>`;
    
    document.getElementById('consequences-container').innerHTML = `
        <div class="item-card" data-consequence-index="0">
            <div class="item-card-header">
                <div class="item-card-title">Consequence #1</div>
                <div class="item-card-actions">
                    <button type="button" class="btn-sm btn-outline" onclick="addControlToConsequence(0)">
                        <i class="fas fa-plus"></i> Add Control
                    </button>
                    <button type="button" class="btn-sm btn-danger" onclick="removeConsequence(0)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label class="required">Consequence Description</label>
                <textarea class="consequence-description" placeholder="Describe the impact" required rows="2"></textarea>
            </div>
            <div class="controls-container">
                <!-- Controls will be added here -->
            </div>
        </div>`;
    
    // Reset counters
    causeCount = 1;
    consequenceCount = 1;
    
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    const nextMonth = new Date();
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    const nextMonthStr = nextMonth.toISOString().split('T')[0];
    
    document.getElementById('exposureStart_create').value = today;
    document.getElementById('exposureEnd_create').value = nextMonthStr;
    document.getElementById('nextReviewDate_create').value = nextMonthStr;
    
    // Load assets if not already loaded
    if (allAssets.length === 0) {
        loadAssignedAssets();
    }
    
    // Focus on first field
    setTimeout(() => {
        const titleInput = document.getElementById('riskTitle_create');
        if (titleInput) titleInput.focus();
    }, 100);
}

function closeCreateRiskModal() {
    document.getElementById('createRiskModal').classList.remove('open');
    document.body.style.overflow = 'auto';
}

async function createNewRisk() {
    const form = document.getElementById('createRiskForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Collect form data with bow-tie structure
    const riskData = {
        // Basic information
        title: document.getElementById('riskTitle_create').value.trim(),
        description: document.getElementById('description_create').value.trim(),
        type: document.getElementById('riskType_create').value,
        assetId: document.getElementById('assetId_create').value || '',
        occurenceLevel: document.getElementById('occurenceLevel_create').value,
        riskOwnerName: document.getElementById('riskOwner_create').value.trim(),
        subProject: document.getElementById('subProject_create').value.trim(),
        functionalAreaTECOP: document.getElementById('functionalAreaTECOP_create').value.trim(),
        event: document.getElementById('event_create').value.trim(),
        exposureStartDate: document.getElementById('exposureStart_create').value || null,
        exposureEndDate: document.getElementById('exposureEnd_create').value || null,
        nextReviewDate: document.getElementById('nextReviewDate_create').value || null,
        
        // Bow-tie left side: Causes with preventive actions
        causes: collectCauses(),
        
        // Bow-tie right side: Consequences with recovery controls
        consequences: collectConsequences(),
        
        // RAM assessment
        projectRamCurrent: document.getElementById('projectRamCurrent_create').value || '',
        projectRamTarget: document.getElementById('projectRamTarget_create').value || '',
        riskVisualRamCurrent: document.getElementById('riskVisualRamCurrent_create').value || '',
        riskVisualRamTarget: document.getElementById('riskVisualRamTarget_create').value || '',
        hsseRamCurrent: document.getElementById('hsseRamCurrent_create').value || '',
        hsseRamTarget: document.getElementById('hsseRamTarget_create').value || '',
        manageability: document.getElementById('manageability_create').value || '',
        thresholdChanging: document.getElementById('thresholdChanging_create').value === 'true'
    };

    console.log('Creating risk:', riskData);

    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/analyst/risks', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(riskData)
        });

        if (!response.ok) {
            let errorMessage = `HTTP error! status: ${response.status}`;
            try {
                const errorData = await response.json();
                errorMessage = errorData.message || errorMessage;
            } catch (e) {
                console.error('Could not parse error response:', e);
            }
            throw new Error(errorMessage);
        }

        const result = await response.json();
        console.log('Risk created successfully:', result);
        
        closeCreateRiskModal();
        showToast('Risk created successfully and submitted for approval! Actions will activate once approved.', 'success');
        
        // Refresh data
        loadRisks();
        
    } catch (error) {
        console.error('Error creating risk:', error);
        showToast(`Failed to create risk: ${error.message}`, 'error');
    }
}

// Risk Visual functionality
function openRiskVisual() {
    // Hide the main content
    document.querySelector('.top-nav').style.display = 'none';
    document.querySelector('.main').style.display = 'none';
    
   
    
    // Create iframe for risk visual
    const visualIframe = document.createElement('iframe');
    visualIframe.style.cssText = 'width:100%;height:100%;border:none;position:fixed;top:0;left:0;z-index:5;';
    visualIframe.src = 'risk-visual.html';  // The risk visual page
    visualIframe.id = 'riskVisualIframe';
    document.body.appendChild(visualIframe);
}

function exitRiskVisual() {
    // Remove iframe and back button
    const iframe = document.getElementById('riskVisualIframe');
    const backButton = document.querySelector('.view-back-btn');
    
    if (iframe) iframe.remove();
    if (backButton) backButton.remove();
    
    // Show original UI
    document.querySelector('.top-nav').style.display = 'flex';
    document.querySelector('.main').style.display = 'block';
    
    // Optionally refresh risks data
    loadRisks();
}

// View risk detail
async function viewRiskDetail(riskId) {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/analyst/risks/${riskId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const risk = await response.json();
        
        // Store risk data for view page
        localStorage.setItem('viewingRisk', JSON.stringify(risk));
        
        // Hide current UI
        document.querySelector('.top-nav').style.display = 'none';
        document.querySelector('.main').style.display = 'none';
        
  
        // Load view in iframe
        const viewIframe = document.createElement('iframe');
        viewIframe.style.cssText = 'width:100%;height:100%;border:none;position:fixed;top:0;left:0;z-index:5;';
        viewIframe.src = 'analyst-risk-detail.html';
        viewIframe.id = 'riskViewIframe';
        document.body.appendChild(viewIframe);
        
    } catch (error) {
        console.error('Error fetching risk details:', error);
        showToast('Failed to load risk details', 'error');
    }
}

// Edit risk (placeholder)
async function editRisk(riskId) {
    showToast('Edit functionality coming soon!', 'warning');
}

// Exit view mode
function exitViewMode() {
    // Remove iframe and back button
    const iframe = document.getElementById('riskViewIframe');
    const backButton = document.querySelector('.view-back-btn');
    
    if (iframe) iframe.remove();
    if (backButton) backButton.remove();
    
    // Show original UI
    document.querySelector('.top-nav').style.display = 'flex';
    document.querySelector('.main').style.display = 'block';
}

// Refresh all data
function refreshRisks() {
    loadRisks();
    showToast('Refreshing data...', 'success');
}

// Toast notification system
function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} toast-icon"></i>
        <div class="toast-message">${message}</div>
    `;
    container.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('show'));
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
    }, 3000);
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    console.log('Analyst risks page loaded');
    
    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/login.html';
        return;
    }
    
    // Load initial data
    loadAssignedAssets();
    loadRisks();
    
    // Set up search
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', searchRisks);
    }
    
    // Close modal on overlay click
    document.getElementById('createRiskModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeCreateRiskModal();
        }
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeCreateRiskModal();
        }
    });
});

// Make functions globally available
window.openCreateRiskModal = openCreateRiskModal;
window.closeCreateRiskModal = closeCreateRiskModal;
window.createNewRisk = createNewRisk;
window.viewRiskDetail = viewRiskDetail;
window.editRisk = editRisk;
window.refreshRisks = refreshRisks;
window.exitViewMode = exitViewMode;
window.addCause = addCause;
window.addActionToCause = addActionToCause;
window.removeCause = removeCause;
window.removeAction = removeAction;
window.addConsequence = addConsequence;
window.addControlToConsequence = addControlToConsequence;
window.removeConsequence = removeConsequence;
window.removeControl = removeControl;
window.updateActionStatus = updateActionStatus;
window.openRiskVisual = openRiskVisual;
window.exitRiskVisual = exitRiskVisual;
</script>
</body>
</html>